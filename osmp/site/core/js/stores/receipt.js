"use strict";System.register(["stores/payment","stores/transaction","stores/terminal"],function(_export,_context){function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Payment,Transaction,Terminal,_createClass;return{setters:[function(_storesPayment){Payment=_storesPayment["default"]},function(_storesTransaction){Transaction=_storesTransaction["default"]},function(_storesTerminal){Terminal=_storesTerminal["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_export("default",new(function(){function _class(){var _this=this;_classCallCheck(this,_class),this.commonData={},this.printedData={},this.printedFailData={},this.virtualData={},this.defaultVirtualOptions={account:!0,money:!0,support:!0},this.defaultVirtual=function(){var _ref=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],inner=_ref.inner,_defaultVirtualOption=_this.defaultVirtualOptions,account=_defaultVirtualOption.account,money=_defaultVirtualOption.money,support=_defaultVirtualOption.support,isBalance=Payment.method===Payment.METHOD.BALANCE,lines=[];return isBalance&&lines.push("ОПЛАТА С БАЛАНСА"),account&&(isBalance?lines.push("Номер кошелька: "+Payment.formattedAccount):lines.push("Номер телефона/счета: "+(Payment.formattedAccount||"отсутствует"))),lines.push("Номер терминала: "+Terminal.id),lines.push("Дата платежа: "+(new Date).toLocaleFormat("%d.%m.%Y %H:%M:%S")),isBalance||lines.push("Код операции: "+Transaction.id),money&&(lines.push(""),isBalance?lines.push("Списано: "+qiwi.utils.toSum(Payment.sum.payment)+" руб."):(lines.push("Принято: "+qiwi.utils.toSum(Transaction.cash)+" руб."),lines.push("Зачислено: "+qiwi.utils.toSum(Transaction.pay)+" руб."),lines.push("Комиссия: "+qiwi.utils.toSum(Transaction.commission)+" руб."))),inner&&(lines.push(""),lines.push(inner)),lines.push(""),!isBalance&&Payment.sum.user>0&&Transaction.change.user>0&&lines.push("Зачисление сдачи на "+Payment.change.fullName+"\n					Номер телефона/счета: "+Payment.change.formattedAccount+"\n					Принято: "+qiwi.utils.toSum(Transaction.change.payment)+" руб.\n					Зачислено: "+qiwi.utils.toSum(Transaction.change.user)+" руб.\n					Комиссия: "+qiwi.utils.toSum(Transaction.change.agentFee)+" руб.\n					"),isBalance||lines.push("Узнать статус платежа: info.qiwi.com"),support&&Terminal.supportPhone&&lines.push("Справочная служба QIWI: "+Terminal.supportPhone),lines.join("\n").replace(/\t/g,"")},this._printed=this._printedFail=function(){return[]},this._virtual=this.defaultVirtual}return _createClass(_class,[{key:"context",value:function(specificData){var commonData=this.commonData instanceof Function?this.commonData():this.commonData||{},customData=specificData instanceof Function?specificData():specificData||{};return Object.assign({},commonData,customData)}},{key:"virtualOptions",set:function(value){try{Object.assign(this.defaultVirtualOptions,value)}catch(e){}}},{key:"printed",get:function(){return this._printed(this.context(this.printedData)).map(function(_ref2){var name=_ref2.name,value=_ref2.value;return{name:"_receipt_"+name,value:value}})||[]},set:function(v){this._printed=v}},{key:"printedFail",get:function(){return this._printedFail(this.context(this.printedFailData)).map(function(_ref3){var name=_ref3.name,value=_ref3.value;return{name:"_receipt_"+name,value:value}})||[]},set:function(v){this._printedFail=v}},{key:"virtual",get:function(){return this.customECompiler?this.customECompiler(this._virtual)||"":this._virtual(this.context(this.virtualData))||""},set:function(v){this._virtual=v}},{key:"template",set:function(){var _this2=this,_ref4=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],successReceipt=_ref4.successReceipt,failReceipt=_ref4.failReceipt,printed=_ref4.printed,printedFail=_ref4.printedFail,virtual=_ref4.virtual,virtualOverride=_ref4.virtualOverride,templateToReceipt=function(template){return function(data){return template.map(function(line){var _line$split=line.split(": "),_line$split2=_toArray(_line$split),name=_line$split2[0],values=_line$split2.slice(1),value=values.join(": ");return{name:qiwi.utils.compileTemplate(name,data),value:qiwi.utils.compileTemplate(value,data)}})}};successReceipt&&(this.printed=templateToReceipt(successReceipt),this.virtual=function(data){return _this2.defaultVirtual({inner:successReceipt.map(function(line){return qiwi.utils.compileTemplate(line.replace(/^: /,""),data)}).join("\n").replace(/<br\/?>/g,"\n")})}),failReceipt&&(this.printedFail=templateToReceipt(failReceipt)),printedFail&&(this.printedFail=templateToReceipt(printedFail)),printed&&(this.printed=templateToReceipt(printed)),virtualOverride&&(this.virtual=function(data){return qiwi.utils.compileTemplate(virtualOverride,data)}),virtual&&(this.virtual=function(data){return _this2.defaultVirtual({inner:qiwi.utils.compileTemplate(virtual,data)})})}}]),_class}()))}}});