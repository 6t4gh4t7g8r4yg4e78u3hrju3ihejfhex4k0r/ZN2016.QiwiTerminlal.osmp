"use strict";System.register(["stores/provider","stores/terminal","stores/transaction","payment","terminal","model/limits","model/commissions"],function(_export,_context){function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Provider,Terminal,Transaction,Old,terminal,Limit,Commissions,_createClass,SCHEME,METHOD;return{setters:[function(_storesProvider){Provider=_storesProvider["default"]},function(_storesTerminal){Terminal=_storesTerminal["default"]},function(_storesTransaction){Transaction=_storesTransaction["default"]},function(_payment){Old=_payment["default"]},function(_terminal){terminal=_terminal["default"]},function(_modelLimits){Limit=_modelLimits.Limit},function(_modelCommissions){Commissions=_modelCommissions.Commissions}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),SCHEME={QD:"qd",QW_OFFLINE:"qw_offline",QW_ONLINE:"qw_online"},METHOD={CASH:"cash",BALANCE:"balance"},_export("default",new(function(){function _class(){_classCallCheck(this,_class),this._sumQueue={inProgress:!1,next:null},this.reset()}return _createClass(_class,[{key:"init",value:function(){var config=arguments.length<=0||void 0===arguments[0]?null:arguments[0],receipt=arguments[1];this.defaultConfig=config||this.defaultConfig||null,Old.init(config,receipt||""),this.defaultConfig&&(Provider.id=this.defaultConfig.paymentProviderId,Provider.walletId=this.defaultConfig.changeWalletId,Provider.offertus=this.defaultConfig.offertus,Provider.currency=this.defaultConfig.currency,Provider.limits={currency:this.defaultConfig.currency||Provider.currency,min:this.defaultConfig.minSum||1,max:this.defaultConfig.maxSum||15e3},this.commissions=this.defaultConfig.qwCommission)}},{key:"reset",value:function(){this._commissions=null,this.resetSum(),this.account=this.accountFormatter=this.qwAccount=null,this._scheme=SCHEME.QD,this._terminalParams=[],this._extraParams=[],this._change={},this._method=null,this.description="",this.init()}},{key:"resetSum",value:function(){this._sum={user:null,qwFee:0,agentFee:0}}},{key:"updateSum",value:function(sum){var _this=this;return sum=Math.max(Number(sum),0)||0,0===sum?(this._sum={user:0,qwFee:0,agentFee:0},Promise.resolve(this.sum)):this._sumQueue.inProgress?new Promise(function(_resolve){var oldResolve=_this._sumQueue.next&&_this._sumQueue.next.resolve;_this._sumQueue.next={sum:sum,resolve:function(){oldResolve&&oldResolve.apply(void 0,arguments),_resolve.apply(void 0,arguments)}}}):(this._sumQueue.inProgress=!0,terminal.send("GetReverseCommissFrom",JSON.stringify({prvId:Number(Provider.id),summ:Number(this.commissions?this.commissions.forwardSum(sum):sum)}),"ReverseCommissFromResult|ReverseRoundedSummFromResult").then(function(){var _ref=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],ReverseCommissFromResult=_ref.ReverseCommissFromResult,ReverseRoundedSummFromResult=_ref.ReverseRoundedSummFromResult;if(ReverseRoundedSummFromResult&&(ReverseCommissFromResult=0),_this._sumQueue.inProgress=!1,isFinite(ReverseCommissFromResult)&&(_this._sum={user:sum,qwFee:_this.commissions?_this.commissions.forward(sum):0,agentFee:Number(ReverseCommissFromResult)}),_this._sumQueue.next){var resolver=_this._sumQueue.next.resolve;(_this._sumQueue.next.sum===sum?Promise.resolve(_this.sum):_this.updateSum(_this._sumQueue.next.sum)).then(resolver),_this._sumQueue.next=null}return _this.sum}))}},{key:"updateChange",value:function(changeObject){return null===changeObject?this._change={}:this._change={id:changeObject.id?Number(changeObject.id):this._change.id,fullName:changeObject.fullName?changeObject.fullName.toString():this._change.fullName,account:changeObject.account||this._change.account,formatter:changeObject.formatter||this._change.formatter,limit:changeObject.limit instanceof Limit?changeObject.limit:changeObject.limit instanceof Object?new Limit(changeObject.limit):this._change.limit||new Limit},this.change}},{key:"addTerminalParam",value:function(_ref2,_ref3){var name=_ref2.name,value=_ref2.value,_ref3$condition=_ref3.condition,condition=void 0===_ref3$condition?function(){return!0}:_ref3$condition,_ref3$step=_ref3.step,step=void 0===_ref3$step?this.TERMINAL_STEP.PAY:_ref3$step;this._terminalParams.push({name:name,value:value,condition:condition,step:step})}},{key:"resetTerminalParams",value:function(){this._terminalParams=[]}},{key:"terminalParams",value:function(requiredStep){return this._terminalParams.map(function(_ref4){var name=_ref4.name,value=_ref4.value,condition=_ref4.condition,step=_ref4.step;return condition()&&requiredStep===step?{name:name,value:value}:null}).filter(function(a){return a})}},{key:"addExtra",value:function(_ref5){var name=_ref5.name,value=_ref5.value,isTransit=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];name&&(this._extraParams=this._extraParams.filter(function(_ref6){var oldName=_ref6.name,oldTransit=_ref6.isTransit;return!(oldName===name&&isTransit===oldTransit)}),this._extraParams.push({name:name,value:value,isTransit:!!isTransit}))}},{key:"getExtra",value:function(name){return this._extraParams.find(function(item){return item.name===name})||{value:""}}},{key:"removeExtra",value:function(name){this._extraParams=this._extraParams.filter(function(item){return item.name!==name})}},{key:"commissions",get:function(){return this._commissions||new Commissions},set:function(v){if(v instanceof Commissions)this._commissions=v;else if(v)try{this._commissions=new Commissions(v)}catch(e){}}},{key:"METHOD",get:function(){return METHOD}},{key:"method",get:function(){return this._method},set:function(type){-1===Object.values(METHOD).indexOf(type)&&null!==type||(this._method=type)}},{key:"sum",get:function(){var _sum=this._sum,user=_sum.user,qwFee=_sum.qwFee,agentFee=_sum.agentFee;return{user:qiwi.utils.round2(user),payment:qiwi.utils.round2(user+qwFee),qwFee:qiwi.utils.round2(qwFee),agentFee:qiwi.utils.round2(agentFee),totalFee:qiwi.utils.round2(agentFee+qwFee),total:qiwi.utils.round2(user+qwFee+agentFee)}}},{key:"change",get:function(){return{id:this._change.id||null,fullName:this._change.fullName||"",account:this._change.account||"",formattedAccount:this._change.formatter?this._change.formatter(this._change.account):this._change.account,limit:this._change.limit||null}}},{key:"accountFormatter",set:function(value){this._accountFormatter=value}},{key:"formattedAccount",get:function(){return this._accountFormatter&&this.account?this._accountFormatter.format(this.account):this.account}},{key:"comment",get:function(){return this._comment||"Оплата ["+Provider.shortName+"] "+qiwi.application.toString()},set:function(value){this._comment=value}},{key:"SCHEME",get:function(){return SCHEME}},{key:"scheme",get:function(){return this._scheme},set:function(type){-1!==Object.values(SCHEME).indexOf(type)&&(this._scheme=type)}},{key:"TERMINAL_STEP",get:function(){return{PAY:"pay",ACCOUNT:"account"}}},{key:"extras",get:function(){var result=[];if(this._scheme===SCHEME.QW_OFFLINE){var glued=this._extraParams.filter(function(item){return item.isTransit});Provider.qw&&!glued.find(function(item){return"id"===item.name})&&glued.push({name:"id",value:Provider.qw}),this.qwAccount&&!glued.find(function(item){return"acc"===item.name})&&glued.push({name:"acc",value:this.qwAccount}),glued.find(function(item){return"sum"===item.name})||glued.push({name:"sum",value:this.sum.user||Terminal.max}),Terminal.id&&!glued.find(function(item){return"trm_id"===item.name})&&glued.push({name:"trm_id",value:Terminal.id}),qiwi.application.toString()&&!glued.find(function(item){return"client-software"===item.name})&&glued.push({name:"client-software",value:qiwi.application.toString()}),result.push({name:"_extra_ev_account0",value:glued.map(function(_ref7){var name=_ref7.name,value=_ref7.value;return name+":"+value+";"}).join("")})}else this._scheme===SCHEME.QD?result.push.apply(result,_toConsumableArray(this._extraParams.filter(function(item){return item.isTransit}).map(function(_ref8){var name=_ref8.name,value=_ref8.value;return{name:"_extra_"+name,value:value}}))):this._scheme===SCHEME.QW_ONLINE&&result.push({name:"_extra_ev_scode",value:Transaction.syncId-1});return result.push.apply(result,_toConsumableArray(this._extraParams.filter(function(item){return!item.isTransit}).map(function(_ref9){var name=_ref9.name,value=_ref9.value;return{name:"_extra_"+name,value:value}}))),result}},{key:"qwExtras",get:function(){return this._extraParams.filter(function(item){return item.isTransit})}}]),_class}()))}}});