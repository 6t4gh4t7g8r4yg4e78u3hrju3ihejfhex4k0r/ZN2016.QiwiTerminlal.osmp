"use strict";System.register([],function(_export,_context){function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _slicedToArray,_createClass,branches,conditions,plugins,Router,parseConditions,BranchTemplate,PluginTemplate,Plugin,Branch,Condition,Page;return{setters:[],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),branches={},conditions={},plugins={},Router=function(){function Router(){_classCallCheck(this,Router),this.stop()}return _createClass(Router,[{key:"start",value:function(map){var _this=this,plugins=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],submap=arguments.length<=2||void 0===arguments[2]?"":arguments[2];return this.stop().then(function(){return Promise.all(Object.keys(plugins).map(function(plugin){return plugins[plugin].init?plugins[plugin].init()["catch"](function(e){return Promise.reject("Failed to initialize "+plugin+" plugin.\n"+e.toString())}):Promise.resolve()}))}).then(function(){_this.addPlugins(plugins),map=map.replace(/\s/g,"").match(/(\$begin.*?\$end|[‰%].*?:\{.*?\}|@.*?:\[.*?\])/g);var start=map.shift();map.forEach(function(string){var name=string.slice(1,string.length).split(":")[0];(string.startsWith("%")||string.startsWith("‰"))&&(conditions[""+(string.startsWith("%")?"implicit_":"")+name]=new(Function.prototype.bind.apply(Condition,[null].concat(_toConsumableArray(string.match(/[‰%](.*):{(.*)}/).slice(1)))))),string.startsWith("@")&&(branches[name.replace("!","")]=new BranchTemplate(string.replace(/.*:\[(.*)\]/,"$1"),name.replace("!",""),{ignored:name.startsWith("!")}))});var conditionMatcher=start.match(/\$(begin[‰%\w]+(?=[‰%>]).*)>\$end/);return new BranchTemplate(submap&&conditionMatcher?conditionMatcher[1]:start.replace(/\$begin[%‰\w]*>/,"").replace(">$end",""))}).then(function(template){return _this.main=new Branch(template,null)})["catch"](function(e){throw new Error("Router errored with: "+e)}).then(function(){return _this.forward()}).then(function(){return submap?_this.jump(submap).then(function(){_this.history.shift(),_this.main.slice(1)})["catch"](function(e){return submap?Promise.reject("Start condition "+submap+" does not exist (error: "+e+")"):null}):null})}},{key:"stop",value:function(){return conditions={},branches={},this.history=[],this.main=null,Promise.resolve()}},{key:"forward",value:function(){return this.update(this.main.forward())}},{key:"back",value:function(){return this.update(this.main.back())}},{key:"jump",value:function(where){return this.update(this.main.jump(where))}},{key:"update",value:function(promise){var _this2=this;return promise.then(function(next){return _this2.history.push(next),_this2.history})}},{key:"addPlugins",value:function(ps){for(var name in ps)plugins[name]=new PluginTemplate(name,ps[name])}},{key:"END",get:function(){return"end"}},{key:"current",get:function(){return this.history[this.history.length-1]||null}},{key:"previous",get:function(){return this.history[this.history.length-2]||null}}],[{key:"END",get:function(){return"end"}}]),Router}(),parseConditions=function(input){return input.map(function(condition){var short=condition.startsWith("%"),fixed=condition.replace(/[←‰%]/g,"");return short?conditions["short_"+fixed]=new Condition("short_"+fixed,""+("←"===condition[1]?condition[1]:"")+fixed+":"+fixed):conditions[fixed]}).filter(function(a){return a})},BranchTemplate=function(){function BranchTemplate(map,name){var _ref=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],_ref$ignored=_ref.ignored,ignored=void 0===_ref$ignored?!1:_ref$ignored,_ref$returns=_ref.returns,returns=void 0===_ref$returns?!1:_ref$returns;_classCallCheck(this,BranchTemplate),this.pages=map.split(">").filter(function(a){return a}),this.name=name,this.ignored=ignored,this.returns=returns}return _createClass(BranchTemplate,[{key:"slice",value:function(count){this.pages=this.pages.slice(count)}}]),BranchTemplate}(),PluginTemplate=function PluginTemplate(name,router){_classCallCheck(this,PluginTemplate),this.name=name,this.router=router},Plugin=function(){function Plugin(template,parent,conditions){_classCallCheck(this,Plugin),this.STRING="Plugin '"+(template.name||"(noname)")+"'"+(this.conditions?" with conditions ["+this.conditions+"]":""),this.router=template.router,this.parent=parent,this.conditions=parseConditions(conditions.replace(/\s/g,"").match(/[%‰][^%‰]+/g)||[]),this.external=null}return _createClass(Plugin,[{key:"condition",value:function(where){return this.conditions.map(function(condition){return condition.at(where)}).find(function(a){return a})}},{key:"forward",value:function(){return this.external?this.external.forward():this.router.forward()}},{key:"back",value:function(){return this.external?this.external.back():this.router.back()}},{key:"jump",value:function(where){return this.external?this.external.jump(where):this.condition(where)?(this.external=new Branch(this.condition(where),this),this.external.forward()):this.router.jump(where)}},{key:"current",get:function(){return this.router.current}}]),Plugin}(),Branch=function(){function Branch(template,parent){if(_classCallCheck(this,Branch),this.STRING="Branch '"+(template.name||"(noname)")+"': "+template.pages.join(" > "),this.index=-1,this.parent=parent,this.pages=this.parse(this.template=template),this.pages.filter(function(page){return!page}).length)throw new Error("Undefined pages in router (map: ["+this.template.pages.join(" | ")+"])!")}return _createClass(Branch,[{key:"parse",value:function(template){var _this3=this;return this.ignored=template.ignored,this.returns=template.returns,template.pages.map(function(name){var ignored=!1;if(name.startsWith("#")){var _name$match=name.match(/#(\w+)((?:[%‰]←?\w+)*)/),_name$match2=_slicedToArray(_name$match,3),plugin=(_name$match2[0],_name$match2[1]),conds=_name$match2[2];return new Plugin(plugins[plugin],_this3,conds)}if(name.startsWith("@"))return branches[name.slice(1,name.length)];if(name.startsWith("%")){var fixed=name.match(/[%‰][^%‰]+/g);fixed.splice(1,0,"‰implicit_"+fixed[0].slice(1)),name=fixed.join("").slice(1)}name.startsWith("!")&&(name=name.slice(1,name.length),ignored=!0);var conditions=name.match(/[%‰][^%‰]+/g);return new Page(name.match(/(\w+)[%‰]?/)[1],{ignored:ignored,conditions:conditions||[]})})}},{key:"forward",value:function(){var _this4=this,fallthrough=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];if(this.page&&this.page instanceof Plugin&&!fallthrough)return this.page.forward()["catch"](function(){return _this4.forward(!0)});if(this.page&&this.page instanceof Branch&&this.page.page)return this.page.forward();if(this.index++,this.index>=this.pages.length){if(this.parent){if(this.parent instanceof Plugin)return this.returns?(this.parent.external=null,this.parent.current):this.parent.parent.forward(!0);if(this.parent.template.pages.length)return this.returns?(this.index=-1,this.parent.page instanceof Plugin?this.parent.page.current:this.parent.back()):this.parent.forward()["catch"](function(e){return _this4.index=_this4.pages.length-1,Promise.reject("Parent is topmost: "+e)})}return this.index=this.pages.length-1,Promise.reject(Router.END)}return this.page instanceof BranchTemplate&&(this.page=new Branch(this.page,this)),this.page instanceof Branch?this.page.forward():this.page instanceof Plugin?this.forward():Promise.resolve(this.page.name)}},{key:"jump",value:function(where){if(this.page&&this.page instanceof Branch)return this.page.jump(where);if(this.page&&this.page instanceof Plugin)return this.page.jump(where);try{return this.pages.splice(this.index+1,0,new Branch(this.page.condition(where),this)),this.index++,this.page.forward()}catch(e){return Promise.reject("Jump failed: "+e)}}},{key:"cleanUp",value:function(){this.page.template.name?this.pages[this.index]=this.page.template:this.page.template&&this.pages.splice(this.index,1)}},{key:"back",value:function(){var _this5=this,fallthrough=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];if(!fallthrough){if(this.page&&this.page instanceof Plugin)return this.page.back()["catch"](function(){return _this5.back(!0)});if(this.page&&this.page instanceof Branch){if(this.page.index>=0)return this.page.back();this.cleanUp()}}if(this.index--,this.index<0){if(this.parent){if(this.parent instanceof Plugin)return this.parent.external=null,this.parent.current;if(this.parent.template.pages.length)return this.parent.back()}return this.index=0,Promise.reject(Router.END)}return this.page instanceof Plugin||this.page instanceof Branch?(this.page.ignored&&this.cleanUp(),this.back(this.page.ignored)):this.page.ignored?this.back():Promise.resolve(this.page.name)}},{key:"slice",value:function(count){this.index=Math.max(0,this.index-count),this.pages=this.pages.slice(count),this.template.slice(count)}},{key:"page",get:function(){return this.pages[this.index]},set:function(what){this.pages[this.index]=what}}]),Branch}(),Condition=function(){function Condition(name,map){_classCallCheck(this,Condition),this.STRING="Condition '"+name+"': "+map,this.ways=map.split(",").filter(function(a){return a}).reduce(function(ways,way){return way=way.split(":"),1===way.length&&way.unshift(name),ways[way[0].replace("←","")]=new BranchTemplate(way[1],null,{returns:way[0].startsWith("←")}),ways},{})}return _createClass(Condition,[{key:"at",value:function(way){return this.ways[way]||null}}]),Condition}(),Page=function(){function Page(name,_ref2){var ignored=_ref2.ignored,conditions=_ref2.conditions;_classCallCheck(this,Page),this.STRING="Page '"+name+"'"+(ignored?" (ignored)":"")+(conditions.length?" with conditions: ["+conditions.join(", ")+"]":""),this.name=name,this.ignored=ignored,this.conditions=parseConditions(conditions)}return _createClass(Page,[{key:"condition",value:function(key){return this.conditions.map(function(condition){return condition.at(key)}).find(function(a){return a})}}]),Page}(),_export("default",new Router)}}});