"use strict";System.register(["jsx!pages/page","acceptor","model/commissions","stores/payment","stores/provider","stores/transaction","jsx!elements/pageHeader","jsx!elements/moneyItem","jsx!elements/button","jsx!elements/commissionProfiles","jsx!elements/tablePopupContent"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,Acceptor,Commission,Payment,Provider,Transaction,PageHeader,MoneyItem,Button,CommissionProfiles,CommissionsPopupContent,_createClass,_get,_class;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_acceptor){Acceptor=_acceptor["default"]},function(_modelCommissions){Commission=_modelCommissions.Commission},function(_storesPayment){Payment=_storesPayment["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_storesTransaction){Transaction=_storesTransaction["default"]},function(_jsxElementsPageHeader){PageHeader=_jsxElementsPageHeader["default"]},function(_jsxElementsMoneyItem){MoneyItem=_jsxElementsMoneyItem["default"]},function(_jsxElementsButton){Button=_jsxElementsButton["default"]},function(_jsxElementsCommissionProfiles){CommissionProfiles=_jsxElementsCommissionProfiles["default"]},function(_jsxElementsTablePopupContent){CommissionsPopupContent=_jsxElementsTablePopupContent["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).apply(this,arguments))}return _inherits(_class,_Page),_createClass(_class,[{key:"onTimeout",value:function(){}},{key:"onShow",value:function(){var _this2=this;return _get(Object.getPrototypeOf(_class.prototype),"onShow",this).call(this).then(function(){return _this2.showPreloader(),_this2.providerName=Provider.fullName,_this2.keyBlocking=!1,_this2.updateNavigation({prevButton:{visible:!1},nextButton:{text:qiwi.i18n("pay_page.forward_button")}}),Transaction.reset(),_this2.cash="0 руб.",_this2.pay_summ="-1",_this2.commiss="-1",_this2.change_summ="-1",_this2.change_commiss="-1",_this2.limits="",_this2.forbidden="",_this2.deficient="",_this2.commissProfiles=[],_this2.coinCommiss={summ:"",commiss:""},_this2.commProfileLine=null,_this2.isSinglePercent=!1,_this2.showCommissionsButton=!0,_this2.acceptor=new Acceptor,_this2.acceptor.on("updateAcceptor",function(updateResult){return _this2.onAcceptorUpdate(updateResult)}),_this2.acceptor.on("timeoutAcceptor",function(){return _this2.onAcceptorTimeout()}),_this2.acceptor.on("preloaderAcceptor",function(show){return _this2.onAcceptorWaiting(show)}),_this2.update(),_this2.maxSumOnDisplay=_this2.displayMaxSum,Provider.limits={min:Provider.limit().min,max:_this2.maxSum,currency:Provider.limit().currency},_this2.acceptor.begin()}).then(function(result){if(_this2.hidePreloader(),_this2.updateNavigation({prevButton:{visible:!1},nextButton:{enabled:!1}}),_this2.commissions=Commission.parseJSON(result.commissions.find(function(item){return item.providerId===Provider.id})),!_this2.commissions)throw new Error("Не существует коммиссии для провайдера "+Provider.id);if(_this2.commissProfiles=_this2.commissions.profiles,_this2.hasQwCommiss=!Payment.commissions.isDummy,_this2.isSinglePercent=_this2.commissions.isSinglePercent&&!_this2.hasQwCommiss,_this2.hasChange=Payment.sum.user>0){if(_this2.fixSum=Payment.sum.payment,_this2.commissions2=Commission.parseJSON(result.commissions.find(function(item){return item.providerId===Payment.change.id})),!_this2.commissions2)throw new Error("Не существует коммиссии для провайдера "+Payment.change.id);_this2.commissProfiles2=_this2.commissions2.profiles,_this2.isSinglePercent2=_this2.commissions2.isSinglePercent,_this2.commissions2.isSinglePercent&&(_this2.showCommissionsButton=!(_this2.commissions.isSinglePercent&&!_this2.hasQwCommiss))}else _this2.commissions.isSinglePercent&&!_this2.hasQwCommiss&&(_this2.showCommissionsButton=!1);_this2.min=result.min,_this2.max=result.max,_this2.limits=qiwi.utils.compileTemplate(qiwi.i18n("pay_page.limits"),{min:qiwi.utils.toSum(_this2.min)+" руб.",max:qiwi.utils.toSum(_this2.maxSumOnDisplay||_this2.max)+" руб."}),_this2.forbidden=result.forbidden,_this2.update()})["catch"](function(error){_this2.hidePreloader(),console.warn("Ошибка при инициализации купюроприемника: "+error),_this2.showPopup({type:"error",title:qiwi.i18n("errors.default"),message:"string"==typeof error?error:qiwi.i18n("pay_page.error_begin_acceptor"),okHandler:function(){return _this2.exit()}})}).done()}},{key:"onAcceptorWaiting",value:function(e){e.show?this.showPreloader():this.hidePreloader()}},{key:"onAcceptorUpdate",value:function(_ref){var _this3=this,cash=_ref.cash,pay_summ=_ref.pay_summ,commiss=_ref.commiss,commissLine=_ref.commissLine,coinCommiss=_ref.coinCommiss,coinCommissValue=_ref.coinCommissValue,change_summ=_ref.change_summ,change_commiss=_ref.change_commiss,minCash=_ref.minCash;if(this.deficient="",cash>0&&(this.cash=qiwi.utils.toSum(cash).toString()+" руб.",Transaction.cash=cash,this.hidePopup()),minCash>0&&(this.min=minCash,this.limits=qiwi.utils.compileTemplate(qiwi.i18n("pay_page.limits"),{min:qiwi.utils.toSum(this.min)+" руб.",max:qiwi.utils.toSum(this.maxSumOnDisplay||this.max)+" руб."})),pay_summ>0){Transaction.pay=pay_summ,Transaction.commission=commiss+coinCommissValue;var userSum=Payment.commissions.reverseSum(Transaction.pay);this.pay_summ=qiwi.utils.toSum(userSum).toString()+" руб.",this.commiss=qiwi.utils.toSum(Transaction.commission+(Transaction.pay-userSum)).toString()+" руб.",coinCommiss&&coinCommissValue>0&&(this.coinCommiss={summ:qiwi.utils.compileTemplate(qiwi.i18n("pay_page.coinCommiss"),{commiss:coinCommiss}),commiss:qiwi.utils.toSum(coinCommissValue).toString()+" руб."})}0===Transaction.pay&&coinCommiss&&(this.coinCommiss={summ:qiwi.utils.compileTemplate(qiwi.i18n("pay_page.coinCommiss"),{commiss:coinCommiss}),commiss:""}),change_summ>0&&(Transaction.changePay=change_summ,Transaction.changeCommission=change_commiss,this.change_summ=qiwi.utils.toSum(change_summ).toString()+" руб.",this.change_commiss=qiwi.utils.toSum(change_commiss).toString()+" руб."),cash>0&&(this.commProfileLine=commissLine-1,Payment.sum.payment>0&&(Payment.sum.payment===pay_summ?this.pay_summ=qiwi.utils.toSum(qiwi.utils.round2(pay_summ)-qiwi.utils.round2(Payment.sum.qwFee)).toString()+" руб.":this.pay_summ=qiwi.utils.toSum(0).toString()+" руб.",this.commiss=qiwi.utils.toSum(Payment.sum.totalFee).toString()+" руб."),this.updateNavigation({prevButton:{visible:!1},nextButton:{enabled:!0},exitButton:{visible:!1}})),this.updateTimer&&clearInterval(this.updateTimer),this.updateTimer=setInterval(function(){return _this3.update()},100)}},{key:"onAcceptorTimeout",value:function(cash){this.performForward({force:!0})}},{key:"performBackward",value:function(){var _this4=this;this.acceptor.end().then(function(result){_this4.acceptor.off("updateAcceptor"),_this4.acceptor.off("timeoutAcceptor"),_this4.acceptor.off("preloaderAcceptor"),_this4.backward()})["catch"](function(error){}).done()}},{key:"performForward",value:function(){var _this5=this;if(!this.keyBlocking)return this.keyBlocking=!0,this.acceptor.pay().then(function(result){return _this5.acceptor.off("updateAcceptor"),_this5.acceptor.off("timeoutAcceptor"),_this5.acceptor.off("preloaderAcceptor"),Transaction.status=result.success?Transaction.STATUS.FULL:Transaction.STATUS.DEFICIENT,Transaction.id=result.txn_id,_this5.keyBlocking=!1,_this5.jump("final")})["catch"](function(error){return _this5.keyBlocking=!1,error.fatal?(_this5.acceptor.off("updateAcceptor"),_this5.acceptor.off("timeoutAcceptor"),_this5.acceptor.off("preloaderAcceptor"),Transaction.status=Transaction.STATUS.ZERO,_this5.jump("final")):(_this5.deficient=error.deficient,_this5.update(),Promise.reject())})}},{key:"performExit",value:function(){var _this6=this;this.keyBlocking||(this.keyBlocking=!0,this.acceptor.end().then(function(result){_this6.keyBlocking=!1,_this6.exit()})["catch"](function(error){_this6.keyBlocking=!1}).done())}},{key:"showCommiss",value:function(){try{var items=[];this.hasQwCommiss&&(items=items.concat([{title:qiwi.i18n("pay_page.commiss_summ"),data:qiwi.i18n("pay_page.qw_commiss_value"),keyStyle:"item-title",valueStyle:"item-title"}].concat(Payment.commissions.profiles.map(function(item){return{title:item.applicability,data:item.comment}})))),items=items.concat([{title:qiwi.i18n("pay_page.commiss_summ"),data:this.hasQwCommiss?qiwi.i18n("pay_page.cash_commiss_value"):qiwi.i18n("pay_page.commiss_value"),keyStyle:"item-title",valueStyle:"item-title"}].concat(this.commissions.profiles.map(function(item){return{title:item.applicability,data:item.comment}}))),!this.hasChange||this.isSinglePercent2&&this.isSinglePercent||(items=items.concat([{title:qiwi.i18n("pay_page.change_commiss_summ"),data:qiwi.i18n("pay_page.change_commiss_value"),keyStyle:"item-title",valueStyle:"item-title"}].concat(this.commissions2.profiles.map(function(item){return{title:item.applicability,data:item.comment}})))),this.showPopup({type:"info",customContent:this.createReactElement(CommissionsPopupContent,{title:qiwi.i18n("pay_page.commiss_popup_title"),items:items}),okButtonText:"Назад"})}catch(error){throw new qiwi.errors.SystemError("Error load element for popup: ",error)}}},{key:"createClass",value:function(){return _get(Object.getPrototypeOf(_class.prototype),"createClass",this).call(this,{getInitialState:function(){return{commissProfiles:[],commissLabel:qiwi.i18n("pay_page.commiss"),changeCommissLabel:qiwi.i18n("pay_page.change_commiss")}},componentWillReceiveProps:function(nextProps){nextProps.commissProfiles&&this.setState({commissProfiles:nextProps.isSinglePercent?[]:nextProps.commProfileLine?nextProps.commissProfiles.slice(nextProps.commProfileLine-1,nextProps.commProfileLine+2):nextProps.commissProfiles.slice(0,3),commissLabel:nextProps.isSinglePercent&&0==nextProps.coinCommiss.summ.length?qiwi.i18n("pay_page.commiss")+" "+qiwi.utils.round2(100*nextProps.commissProfiles[0].rate)+"%":qiwi.i18n("pay_page.commiss"),changeCommissLabel:nextProps.isSinglePercent2?qiwi.i18n("pay_page.change_commiss")+" "+qiwi.utils.round2(100*nextProps.commissProfiles2[0].rate)+"%":qiwi.i18n("pay_page.change_commiss")})},render:function(){var _this7=this;return React.createElement("div",{id:"payment-page"},React.createElement("div",{className:"pay-container"},React.createElement(PageHeader,{provider:this.props.providerName,title:qiwi.i18n("pay_page.title")}),React.createElement("div",{className:"limits"},this.props.limitsInfo),this.props.forbiddenInfo?React.createElement("div",{className:"forbidden"},React.createElement("div",null,this.props.forbiddenInfo)):null,React.createElement("div",{className:"main"},React.createElement("div",{className:"items"},React.createElement(MoneyItem,{label:qiwi.i18n("pay_page.cash"),warn:this.props.deficient&&this.props.deficient.length>0,bubble:this.props.deficient,value:this.props.cash}),React.createElement(MoneyItem,{label:qiwi.i18n("pay_page.pay_summ"),warn:!1,bubble:"",value:this.props.pay_summ}),React.createElement(MoneyItem,{label:this.state.commissLabel,warn:!1,bubble:"",value:this.props.commiss}),this.props.additionalMoneyItems?this.props.additionalMoneyItems.map(function(item){return React.createElement(MoneyItem,{label:item.label,warn:!1,bubble:"",value:item.value})}):null,this.props.hasChange?React.createElement("div",null,React.createElement(MoneyItem,{isSmallSize:!0,label:qiwi.i18n("pay_page.change_summ"),warn:!1,bubble:"",value:this.props.change_summ}),React.createElement(MoneyItem,{isSmallSize:!0,label:this.state.changeCommissLabel,warn:!1,bubble:"",value:this.props.change_commiss})):null)),this.state.commissProfiles.length>0&&!this.props.hasQwCommiss?React.createElement(CommissionProfiles,{summTitle:qiwi.i18n("pay_page.commiss_summ_title"),commissTitle:qiwi.i18n("pay_page.commiss_value_title"),className:"commissionProfiles",profiles:this.state.commissProfiles,coin:this.props.coinCommiss,selected:this.props.commProfileLine}):null,this.props.showCommissionsButton?React.createElement(Button,{className:"commiss-button",text:qiwi.i18n("pay_page.commiss_button"),onClick:function(){return _this7.props.showCommissions()}}):null,null),this.props.additionalInfo?React.createElement("div",{className:"additionalInfo"},this.props.additionalInfo):null)}})}},{key:"maxSum",get:function(){return Provider.limit().max}},{key:"displayMaxSum",get:function(){return 0}},{key:"props",get:function(){var _this8=this;return{cash:this.cash,pay_summ:this.pay_summ,pay_summ_in_curr:this.pay_summ_in_curr,commiss:this.commiss,limitsInfo:this.limits,forbiddenInfo:this.forbidden,deficient:this.deficient,additionalInfo:this.additionalInfo,commissProfiles:this.commissProfiles,coinCommiss:this.coinCommiss,commProfileLine:this.commProfileLine,isSinglePercent:this.isSinglePercent,hasQwCommiss:this.hasQwCommiss,hasChange:this.hasChange,change_summ:this.change_summ,change_commiss:this.change_commiss,fixSum:this.fixSum,commissions2:this.commissions2,commissProfiles2:this.commissProfiles2,isSinglePercent2:this.isSinglePercent2,providerName:Provider.fullName,showCommissionsButton:this.showCommissionsButton,additionalMoneyItems:this.additionalMoneyItems,showCommissions:function(){return _this8.showCommiss()}}}}]),_class}(Page),_export("default",_class)}}});