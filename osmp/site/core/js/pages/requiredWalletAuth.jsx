"use strict";System.register(["jsx!pages/page","model/user","jsx!elements/walletAuth"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,User,WalletAuth,_createClass,_class;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_modelUser){User=_modelUser["default"]},function(_jsxElementsWalletAuth){WalletAuth=_jsxElementsWalletAuth["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).apply(this,arguments))}return _inherits(_class,_Page),_createClass(_class,[{key:"checkAuth",value:function(){var _this2=this,_ref=arguments.length<=0||void 0===arguments[0]?{full:!1}:arguments[0],full=_ref.full;return new Promise(function(resolve,reject){_this2.actionWithAuth({onCancel:reject,onFail:reject,action:function(){_this2.request("wallet.auth-user",{phone:"7"+User.login.src,pin:User.pin,trm_id:qiwi.terminal.id,version:qiwi.application.toString()}).then(function(result){var _result$response$data=result.response.data,balances=_result$response$data.balances,ussdEnabled=_result$response$data.ussdEnabled;User.balances=balances,User.ussdEnabled=ussdEnabled,resolve()},reject)},full:full})})}},{key:"checkSimpleAuth",value:function(){return this.checkAuth()}},{key:"checkFullAuth",value:function(){return this.checkAuth({full:!0})}},{key:"actionWithAuth",value:function(_ref2){var _this3=this,action=_ref2.action,full=_ref2.full,_onSuccess=_ref2.onSuccess,_onCancel=_ref2.onCancel,onFail=_ref2.onFail;User.authorizeState.authorized&&!full||User.authorizeState.full&&full?action&&action():!function(){var getAuth=function(){return _this3.showModal({page:WalletAuth,data:{onCancel:function(){_this3.hideModal(),_onCancel&&_onCancel()},onSuccess:function(){_this3.hideModal(),_onSuccess&&_onSuccess(),action&&action()},needFull:full}})};User.authorizeState.authorized&&!User.hasPin&&full?_this3.showPopup({type:"question",title:qiwi.i18n("wallet_popups.generatePin.title"),message:qiwi.utils.compileTemplate(qiwi.i18n("wallet_popups.generatePin.text"),{phone:User.login.formatted}),okHandler:function(){_this3.request("wallet.register-user",{phone:"7"+User.login.src,trm_id:qiwi.terminal.id,version:qiwi.application.toString()}).then(function(result){_this3.showPopup({type:"attention",okHandler:function(){User.pin="",User.hasPin=!0,getAuth()},message:qiwi.utils.compileTemplate(qiwi.i18n("pinPage.generatePin.pin_sent"),{phone:User.login.formatted})})},function(){for(var _len=arguments.length,args=Array(_len),_key=0;_len>_key;_key++)args[_key]=arguments[_key];if(onFail)return onFail.apply(void 0,args);throw new qiwi.errors.UserError(args[0].message)})},okButtonText:qiwi.i18n("wallet_popups.generatePin.ok"),cancelButtonText:qiwi.i18n("wallet_popups.generatePin.cancel")}):getAuth()}()}}]),_class}(Page),_export("default",_class)}}});