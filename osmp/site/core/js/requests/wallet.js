"use strict";System.register(["terminal","stores/provider","xmlToJSON","handlers/xml/authUser","handlers/xml/checkUser","handlers/xml/authUserWithInvoices","handlers/xml/baseXml","handlers/xml/history","handlers/xml/rates","handlers/xml/invoicePayment","handlers/xml/checkInvoicePaymentStatus","handlers/xml/checkUserLimits","handlers/xml/getDutiesRequisities","handlers/xml/balancePayment","handlers/xml/smsConfirm","handlers/xml/smsConfirmResend","handlers/xml/checkUserTopup","handlers/xml/favouritesList"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var terminal,Provider,xmlToJSON,AuthUserHandler,CheckUserHandler,AuthUserWithInvoicesHandler,BaseHandler,HistoryHandler,RatesHandler,InvoicePaymentHandler,CheckInvoicePaymentStatusHandler,CheckUserLimitsHandler,GetDutiesRequisitiesHandler,BalancePaymentHandler,SmsConfirmHandler,SmsConfirmResendHandler,CheckUserTopupHandler,FavouritesListHandler,_createClass,escapeXML,_class;return{setters:[function(_terminal){terminal=_terminal["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_xmlToJSON){xmlToJSON=_xmlToJSON["default"]},function(_handlersXmlAuthUser){AuthUserHandler=_handlersXmlAuthUser["default"]},function(_handlersXmlCheckUser){CheckUserHandler=_handlersXmlCheckUser["default"]},function(_handlersXmlAuthUserWithInvoices){AuthUserWithInvoicesHandler=_handlersXmlAuthUserWithInvoices["default"]},function(_handlersXmlBaseXml){BaseHandler=_handlersXmlBaseXml["default"]},function(_handlersXmlHistory){HistoryHandler=_handlersXmlHistory["default"]},function(_handlersXmlRates){RatesHandler=_handlersXmlRates["default"]},function(_handlersXmlInvoicePayment){InvoicePaymentHandler=_handlersXmlInvoicePayment["default"]},function(_handlersXmlCheckInvoicePaymentStatus){CheckInvoicePaymentStatusHandler=_handlersXmlCheckInvoicePaymentStatus["default"]},function(_handlersXmlCheckUserLimits){CheckUserLimitsHandler=_handlersXmlCheckUserLimits["default"]},function(_handlersXmlGetDutiesRequisities){GetDutiesRequisitiesHandler=_handlersXmlGetDutiesRequisities["default"]},function(_handlersXmlBalancePayment){BalancePaymentHandler=_handlersXmlBalancePayment["default"]},function(_handlersXmlSmsConfirm){SmsConfirmHandler=_handlersXmlSmsConfirm["default"]},function(_handlersXmlSmsConfirmResend){SmsConfirmResendHandler=_handlersXmlSmsConfirmResend["default"]},function(_handlersXmlCheckUserTopup){CheckUserTopupHandler=_handlersXmlCheckUserTopup["default"]},function(_handlersXmlFavouritesList){FavouritesListHandler=_handlersXmlFavouritesList["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),escapeXML=function(string){return string&&string.toString().replace(/"/g,"'").replace(/[&%]/g,"")||""},_class=function(){function _class(type){_classCallCheck(this,_class),this.aid=1,this.template="",this.timeout=30,this.urls=["https://w.qiwi.com/xml/xmlutf.jsp","https://service1.osmp.ru/wallet/xmlutf.jsp","https://service2.osmp.ru/wallet/xmlutf.jsp"],this.type=type}return _createClass(_class,[{key:"templates",value:function(context){return[{type:"check-user",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n                    <request>\n                        <request-type>check-user</request-type>\n                        <terminal-id>'+context.login+'</terminal-id>\n                        <extra name="mylk-pin">'+context.pin+'</extra>\n                        <extra name="phone">'+context.phone+'</extra>\n                        <extra name="with-ident-status">'+context.with_ident_status+'</extra>\n                        <extra name="check_pin">'+context.check_pin+'</extra>\n                       <extra name="client-software">'+context.version+"</extra>\n                    </request>"},handler:new BaseHandler},{type:"confirm-user-profile",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n                    <request>\n                        <terminal-id>'+context.login+'</terminal-id>\n                        <extra name="mylk-pin">'+context.pin+'</extra>\n                        <request-type>confirm-user-profile</request-type>\n                        <extra name="client-software">'+context.version+"</extra>\n                        <phone>"+context.phone+"</phone>\n                        <first-name>"+context.first_name+"</first-name>\n                        <last-name>"+context.last_name+"</last-name>\n                        <middle-name>"+context.middle_name+"</middle-name>\n                        <birth-date>"+context.birth_date+"</birth-date>\n                        <passport-number>"+context.passport_number+"</passport-number>\n                        "+context.second_documents+"\n                    </request>"},handler:new BaseHandler},{type:"get-user-profile",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n                    <request>\n                      <terminal-id>'+context.login+'</terminal-id>\n                      <extra name="mylk-pin">'+context.pin+'</extra>\n                        <request-type>get-user-profile</request-type>\n                       <extra name="client-software">'+context.version+"</extra>\n                    </request>"},handler:new BaseHandler},{type:"send-pin",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n                    <request>\n                      <terminal-id>'+context.phone+'</terminal-id>\n                      <request-type>send-pin</request-type>\n                      <extra name="client-software">'+context.version+"</extra>\n                    </request>"},handler:new BaseHandler},{type:"get-cross-rates",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n                        <request>\n							<protocol-version>4.00</protocol-version>\n							<request-type>get-cross-rates</request-type>\n							<types>\n								<cbrf/>\n							</types>\n							'+context.rates+'\n							 <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:new BaseHandler},{type:"get-cross-rates-all",body:function(){return'<?xml version="1.0" encoding="utf-8"?>\n	                        <request>\n								<protocol-version>4.00</protocol-version>\n								<request-type>get-cross-rates</request-type>\n								<extra name="client-software">'+context.version+"</extra>\n							</request>"},handler:RatesHandler},{type:"bean-get-identification-status-terminal",body:function(){return'<request>\n						<request-type>bean</request-type>\n				         <request>\n				           <request-type>get-identification-status-terminal</request-type>\n				           <extra name="terminal">'+context.trm_id+'</extra>\n				           <extra name="phone">'+context.phone+'</extra>\n				           <extra name="client-software">'+context.version+"</extra>\n				         </request>\n					  </request>"},handler:new BaseHandler},{type:"check-user-complex",body:function(){return'<request>\n						<request-type>bean</request-type>\n						  <request>\n							  <request-type>get-identification-status-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n						  <request>\n							  <request-type>check-user-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="cur">1</extra>\n							  <extra name="ccy">'+context.currency+'</extra>\n							  <extra name="with-mf-status">'+context.check_megafon+'</extra>\n							  <extra name="check_pin">'+context.check_pin+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n						   <request>\n							  <request-type>get-limits-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="currency">'+context.currency+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n				          <extra name="client-software">'+context.version+"</extra>\n				        </request>"},handler:CheckUserHandler},{type:"check-user-topup",body:function(){return'<request>\n						<request-type>bean</request-type>\n						  <request>\n							  <request-type>get-identification-status-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n						  <request>\n							  <request-type>check-user-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="cur">1</extra>\n							  <extra name="ccy">'+context.currency+'</extra>\n							  <extra name="with-mf-status">'+context.check_megafon+'</extra>\n							  <extra name="check_pin">'+context.check_pin+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n						   <request>\n							  <request-type>get-limits-terminal</request-type>\n							  <extra name="terminal">'+context.trm_id+'</extra>\n							  <extra name="phone">'+context.phone+'</extra>\n							  <extra name="currency">'+context.currency+'</extra>\n							  <extra name="client-software">'+context.version+'</extra>\n						  </request>\n						   <request>\n							   <request-type>get-wallet-user</request-type>\n							   <extra name="terminal">'+context.trm_id+"</extra>\n							   <wallet-id>"+context.phone+'</wallet-id>\n							   <extra name="client-software">'+context.version+'</extra>\n							</request>\n				          <extra name="client-software">'+context.version+"</extra>\n				        </request>"},handler:CheckUserTopupHandler},{type:"check-user-limits",body:function(){return'<request>\n							<request-type>bean</request-type>\n							  <request>\n								  <request-type>check-user-terminal</request-type>\n								  <extra name="terminal">'+context.trm_id+'</extra>\n								  <extra name="phone">'+context.phone+'</extra>\n								  <extra name="cur">1</extra>\n								  <extra name="ccy">'+context.currency+'</extra>\n								  <extra name="with-mf-status">'+context.check_megafon+'</extra>\n								  <extra name="check_pin">'+context.check_pin+'</extra>\n								  <extra name="client-software">'+context.version+'</extra>\n							  </request>\n							  <request>\n								  <request-type>get-limits-terminal</request-type>\n								  <extra name="terminal">'+context.trm_id+'</extra>\n								  <extra name="phone">'+context.phone+'</extra>\n								  <extra name="currency">'+context.currency+'</extra>\n								  <extra name="client-software">'+context.version+'</extra>\n							  </request>\n							  <request>\n								  <request-type>get-identification-status-terminal</request-type>\n								  <extra name="terminal">'+context.trm_id+'</extra>\n								  <extra name="phone">'+context.phone+'</extra>\n								  <extra name="client-software">'+context.version+'</extra>\n							  </request>\n							  <extra name="client-software">'+context.version+"</extra>\n							</request>"},handler:CheckUserLimitsHandler},{type:"auth-user",body:function(){return'<request>\n						  <request-type>ping</request-type>\n						  <extra name="terminal">'+context.trm_id+"</extra>\n						  <terminal-id>"+context.phone+'</terminal-id>\n						  <extra name="mylk-pin">'+context.pin+'</extra>\n						  <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:AuthUserHandler},{type:"auth-user-with-invoices",body:function(){return'<request>\n							<request-type>list-bill</request-type>\n							<extra name="client-software">'+context.version+"</extra>\n							<terminal-id>"+context.phone+'</terminal-id>\n							<extra name="mylk-pin">'+context.pin+'</extra>\n							<extra name="terminal">'+context.trm_id+'</extra>\n							<extra name="dir">0</extra>\n							<extra name="from">'+context.from+'</extra>\n							<extra name="to">'+context.to+"</extra>\n						</request>"},handler:AuthUserWithInvoicesHandler},{type:"change-pin",body:function(){return"<request>\n						 <request-type>change-pin</request-type>\n						  <pin>"+context.new_pin+'</pin>\n						  <extra name="mylk-pin">'+context.pin+"</extra>\n						  <terminal-id>"+context.phone+"</terminal-id>\n						  <trm-id>"+context.trm_id+'</trm-id>\n						  <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:new BaseHandler},{type:"register-user",body:function(){return'<request>\n							<request-type>add-new-mylk</request-type>\n							<extra name="client-software">'+context.version+'</extra>\n							<extra name="phone">'+context.phone+"</extra>\n							<trm-id>"+context.trm_id+"</trm-id>\n						</request>"},handler:new BaseHandler},{type:"history",body:function(){return'<request>\n						  <request-type>get-payments-report</request-type>\n						  <extra name="client-software">'+context.version+"</extra>\n						  <terminal-id>"+context.login+'</terminal-id>\n						  <extra name="mylk-pin">'+context.pin+"</extra>\n						  <period>custom</period>\n						  <from-date>"+context.begin+"</from-date>\n						  <to-date>"+context.end+"</to-date>\n						  <full>1</full>\n						</request>"},handler:HistoryHandler},{type:"invoice-pay",body:function(){return'<request>\n							  <protocol-version>4.00</protocol-version>\n							  <request-type>mylk-accept-bill</request-type>\n							  <extra name="mylk-pin">'+context.pin+"</extra>\n							  <terminal-id>"+context.login+"</terminal-id>\n							  <trm-id>"+context.trm_id+'</trm-id>\n							  <extra name="client-software">'+context.version+'</extra>\n							  <extra name="ccy">'+context.currency+"</extra>\n							  "+context.group_id+"\n							  "+context.invoices+"\n							</request>"},handler:InvoicePaymentHandler},{type:"check-invoice-payment-status",body:function(){return'<request>\n								<request-type>list-bill</request-type>\n								<extra name="client-software">'+context.version+"</extra>\n								<terminal-id>"+context.phone+'</terminal-id>\n								<extra name="mylk-pin">'+context.pin+'</extra>\n								<extra name="terminal">'+context.trm_id+'</extra>\n								<extra name="dir">0</extra>\n								<extra name="from">'+context.from+'</extra>\n								<extra name="to">'+context.to+"</extra>\n							</request>"},handler:CheckInvoicePaymentStatusHandler},{type:"get-duties-requisities",body:function(){return'<request>\n								<protocol-version>4.00</protocol-version>\n								<request-type>get-ogv-info</request-type>\n								<extra name="region">'+context.region+'</extra>\n								<extra name="type">'+context.type+'</extra>\n								<extra name="div">'+context.div+"</extra>\n							</request>"},handler:GetDutiesRequisitiesHandler},{type:"balance-payment",body:function(){return"<request>\n									<protocol-version>4</protocol-version>\n									<request-type>pay</request-type>\n									<trm-id>"+context.trm_id+"</trm-id>\n									<terminal-id>"+context.login+'</terminal-id>\n									<extra name="mylk-pin">'+context.pin+'</extra>\n									<extra name="client-software">'+context.version+'</extra>\n									<auth count="1" to-amount="1">\n										<payment>\n											<from>\n												<amount>'+context.amount+"</amount>\n												<service-id>4</service-id>\n												<account-number>"+context.trm_id+"</account-number>\n												<ccy>"+context.ccy_from+"</ccy>\n											</from>\n											<to>\n												<amount>"+context.amount+"</amount>\n												<service-id>"+context.prv_id+"</service-id>\n												<account-number>"+context.account+"</account-number>\n												<ccy>"+context.ccy_to+"</ccy>\n											</to>\n											"+context.extras+'\n											<extra name="terminal_prefer_sms_to_ussd">true</extra>\n											<transaction-number>'+context.transaction_number+"</transaction-number>\n										</payment>\n									</auth>\n								</request>"},handler:BalancePaymentHandler},{type:"smsconfirm-confirm",body:function(){return"<request>\n								<protocol-version>4.00</protocol-version>\n								<request-type>smsconfirm-confirm</request-type>\n								<terminal-id>"+context.login+'</terminal-id>\n								<extra name="mylk-pin">'+context.pin+'</extra>\n								<extra name="terminal">'+context.trm_id+'</extra>\n								<confirm type="'+context.confirmType+'">\n	                                <trm_txn_id>'+context.txn+"</trm_txn_id>\n									<code>"+context.code+"</code>\n									"+context.extra+'\n								</confirm>\n								<extra name="client-software">'+context.version+"</extra>\n							</request>"},handler:SmsConfirmHandler},{type:"smsconfirm-resend",body:function(){return"<request>\n							<protocol-version>4.00</protocol-version>\n							<request-type>smsconfirm-resend</request-type>\n							<terminal-id>"+context.login+'</terminal-id>\n							<extra name="mylk-pin">'+context.pin+'</extra>\n							<extra name="terminal">'+context.trm_id+'</extra>\n							<resend type="'+context.resendType+'">\n							    <trm_txn_id>'+context.txn+"</trm_txn_id>\n								"+context.extra+'\n						    </resend>\n						    <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:SmsConfirmResendHandler},{type:"favourites-list",body:function(){return"<request>\n							<protocol-version>4.00</protocol-version>\n							<request-type>get-ab</request-type>\n							<terminal-id>"+context.login+'</terminal-id>\n							<extra name="mylk-pin">'+context.pin+'</extra>\n						    <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:new FavouritesListHandler(context.providerId)},{type:"favourites-save",body:function(){return"<request>\n							<protocol-version>4.00</protocol-version>\n							<request-type>add-ab-item</request-type>\n							<item-list>\n								<item>\n									<title>Платеж "+escapeXML(Provider.shortName)+"</title>\n									<id>"+context.id+"</id>\n									<prv>"+context.providerId+"</prv>\n									<account>"+escapeXML(context.fields.account)+"</account>\n									<amount>"+context.amount+"</amount>\n									<from-cur>"+Provider.currency+"</from-cur>\n									<to-cur>"+Provider.currency+"</to-cur>\n									"+Object.keys(context.fields).filter(function(field){return"account"!==field}).map(function(field){return'<extra name="'+field+'">'+escapeXML(context.fields[field])+"</extra>"}).join("")+"\n								</item>\n							</item-list>\n							<terminal-id>"+context.login+'</terminal-id>\n							<extra name="mylk-pin">'+context.pin+'</extra>\n						    <extra name="client-software">'+context.version+"</extra>\n						</request>"},handler:new BaseHandler},{type:"favourites-remove",body:function(){return"<request>\n								<protocol-version>4.00</protocol-version>\n								<request-type>del-ab-item</request-type>\n								<terminal-id>"+context.login+'</terminal-id>\n								<extra name="mylk-pin">'+context.pin+'</extra>\n							    <extra name="client-software">'+context.version+"</extra>\n							    <item-list>\n									<item>"+context.id+"</item>\n								</item-list>\n							</request>"},handler:new BaseHandler}]}},{key:"currentUrl",value:function(_urls,_index){return _urls[_index-1]}},{key:"getTemplate",value:function(elementType,context){return this.templates(context).filter(function(_ref){var type=_ref.type;return type===elementType})}},{key:"prepareRequest",value:function(url,aid,timeout,template,headers){return JSON.stringify({url:url,method:"POST",request:template.replace(/\n/g,"").replace(/\t/g,""),headers:headers})}},{key:"send",value:function(params){var _this=this,type=this.type;if(console.info("send "+type),this.template=this.getTemplate(type,params)[0].body(),this.handler=this.getTemplate(type,params)[0].handler,this.urls=params.urls?params.urls:this.urls,this.template&&this.currentUrl(this.urls,this.aid))return new Promise(function(resolve,reject){function execute(){var request=self.prepareRequest(self.currentUrl(params.urls?params.urls:self.urls,self.aid),self.aid,self.timeout,self.template,params.headers?params.headers:{});terminal.send("network.proxy",request,"network.proxy").then(function(res){if("error"===res["network.proxy"])reject({type:type,code:-100,message:qiwi.i18n("requests.unknown")});else{var result=JSON.parse(res["network.proxy"]),resultCode=parseFloat(result["result-code"]);switch(resultCode){case 0:var bodyXml=result.response.replace(/<\?xml(.+?)\?>/g,""),response=xmlToJSON.parseString(bodyXml).response[0];"0"===response["result-code"][0]._text?resolve({response:{code:"0",message:"OK",body:response,bodyXml:bodyXml,data:self.handler?self.handler.parse(bodyXml,params):null}}):reject({type:type,code:response["result-code"][0]._text,message:response["result-code"][0]._attr.message._value});break;case 600:self.currentUrl(self.urls,self.aid+1)?(self.aid++,execute()):reject({type:type,code:resultCode,message:qiwi.i18n("requests.timeout")});break;default:reject({type:type,code:resultCode,message:qiwi.i18n("requests.unknown")})}}})["catch"](function(error){reject({type:type,code:-1,message:error})})}var self=_this;execute()})["catch"](function(error){return Promise.reject(error)});var error=new Error("Unhandled request error["+type+"]",-103);return console.error(error),Promise.reject(error)}}]),_class}(),_export("default",_class)}}});