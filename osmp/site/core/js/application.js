"use strict";System.register(["config","router","dictionary","terminal","stores/payment","statistics","storage","stores/terminal","actions/appUpdate","stores/configureStore","jsx!pages/mainPage"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var config,router,dictionary,terminal,Payment,statistics,Storage,TerminalObject,updatePageData,configureStore,MainPage,_slicedToArray,_createClass,_ReactRedux,Provider,Application;return{setters:[function(_config){config=_config["default"]},function(_router){router=_router["default"]},function(_dictionary){dictionary=_dictionary["default"]},function(_terminal){terminal=_terminal["default"]},function(_storesPayment){Payment=_storesPayment["default"]},function(_statistics){statistics=_statistics["default"]},function(_storage){Storage=_storage["default"]},function(_storesTerminal){TerminalObject=_storesTerminal["default"]},function(_actionsAppUpdate){updatePageData=_actionsAppUpdate.updatePageData},function(_storesConfigureStore){configureStore=_storesConfigureStore["default"]},function(_jsxPagesMainPage){MainPage=_jsxPagesMainPage["default"]}],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_ReactRedux=ReactRedux,Provider=_ReactRedux.Provider,Application=function(){function Application(id,scenario,version){_classCallCheck(this,Application),qiwi.errorHandler(this),qiwi.application.name=id,qiwi.application.scenario=scenario,qiwi.application.core.version=version,this.pages={},this.reactProps={}}return _createClass(Application,[{key:"begin",value:function(){var _this=this;return qiwi.utils.require("text!locales.json").then(function(_ref){var _ref2=_slicedToArray(_ref,1),data=_ref2[0];return dictionary.init(JSON.parse(data))}).then(function(){return config.init(qiwi.application.name,qiwi.application.scenario)})["catch"](function(e){throw new qiwi.errors.SystemError("Unable to load "+qiwi.application.name+"!",e)}).then(function(){window.terminal.OnResponse=function(key,value){return terminal.receive(key,value)},TerminalObject.init(),dictionary.init(config.locales),Payment.init(config.payment,config.receipt),qiwi.application.version=config.json.version,statistics.init(qiwi.application.name,qiwi.application.scenario,qiwi.application.version+"/"+qiwi.application.core.version),console.warn("START "+qiwi.application.toString()),statistics.startApp(Storage.get("provider")?{provider:Storage.get("provider")}:{}),qiwi.utils.require("./css/styles-"+(document.config.isLight?"light":"classic")+".css"),qiwi.utils.require("../projects/"+qiwi.application.name+"/css/styles-"+(document.config.isLight?"light":"classic")+".css")["catch"](function(){return qiwi.utils.require("../projects/"+qiwi.application.name+"/css/styles.css")["catch"](function(){})})})["catch"](function(e){return Promise.reject("Ошибка инициализации: "+e)}).then(function(){return _this.renderApp()}).then(function(){return qiwi.utils.require("initial")}).then(function(_ref3){var _ref4=_slicedToArray(_ref3,1),initial=_ref4[0];return initial.run()}).then(function(submap){return router.start(config.map,config.plugins,submap)}).done(function(){return _this.show(router.current)},function(e){throw new qiwi.errors.UserError("Платеж на данном терминале невозможен.",e,qiwi.errors.ACTIONS.EXIT)})}},{key:"renderApp",value:function(){this.store=configureStore(),ReactDOM.render(React.createElement(Provider,{store:this.store},React.createElement(MainPage,null)),document.getElementById("content"))}},{key:"updateContext",value:function(newProps){null===newProps&&(this.reactProps={}),qiwi.utils.extend(this.reactProps,newProps),updatePageData(this.store.dispatch,this.reactProps)}},{key:"updatePage",value:function(newProps){this.reactProps.pageData=newProps||{},updatePageData(this.store.dispatch,this.reactProps)}},{key:"end",value:function(){return router.stop()}},{key:"exit",value:function(parameters){return qiwi.utils.require("exit").then(function(_ref5){var _ref6=_slicedToArray(_ref5,1),exit=_ref6[0];return exit.run(parameters)})}},{key:"change",value:function(routerAction){var _this2=this;return this.hide(router.current),routerAction()["catch"](function(flag){return flag===router.END?_this2.exit():Promise.reject("No need to show the page")}).then(function(){return _this2.show(router.current)}).done()}},{key:"show",value:function(name){var _this3=this;return console.log("Page to show: "+name),this.updateContext({preloader:null,navigation:{block:!0}}),(this.pages[name]?Promise.resolve(this.pages[name]):qiwi.utils.require("pages/"+name+".jsx").then(function(_ref7){var _ref8=_slicedToArray(_ref7,1),Page=_ref8[0];return _this3.pages[name]=new Page(name)}))["catch"](function(e){throw new qiwi.errors.SystemError("Error in getPage: "+e)}).then(function(result){return _this3.current=result,_this3.listen(_this3.current),_this3.updateContext({pageRef:_this3.current}),Promise.resolve().then(function(){return _this3.current.createClass()}).then(function(pageClass){return _this3.current.trigger(qiwi.events.REACT.PAGE_CLASS,pageClass)})["catch"](function(error){return Promise.reject("Error on creating class ("+name+"): "+error)})}).then(function(){return updatePageData(_this3.store.dispatch,_this3.reactProps)}).then(function(){return Promise.resolve().then(function(){return _this3.current.onShow()})["catch"](function(error){return Promise.reject("Error on onShow invocation ("+name+"): "+error)})}).then(function(){_this3.updateContext({navigation:{block:!1}}),_this3.current&&statistics.showPage(_this3.current&&_this3.current.name||router.current)})["catch"](function(error){return Promise.reject("Error loading page "+name+": "+error)})}},{key:"hide",value:function(name){return console.log("Page to hide: "+name),this.updateContext(null),this.current.showPreloader(),this.unlisten(this.pages[name]),this.current=null,this.pages[name].onHide()}},{key:"listen",value:function(pageToSubscribe){var _this4=this;if(!pageToSubscribe)throw new Error("Page is "+pageToSubscribe+" while being subscribed to!");pageToSubscribe.on(qiwi.events.REACT.POPUP,function(popup){return _this4.updateContext({popup:popup})}),pageToSubscribe.on(qiwi.events.REACT.PRELOADER,function(preloader){return _this4.updateContext({preloader:preloader})}),pageToSubscribe.on(qiwi.events.REACT.MODAL,function(config){return _this4.updateContext({modal:config?{page:config.page,data:config.data}:null})}),pageToSubscribe.on(qiwi.events.REACT.HEADER,function(header){return _this4.updateContext({header:header})}),pageToSubscribe.on(qiwi.events.REACT.NAVIGATION,function(navigation){return _this4.updateContext({navigation:navigation})}),pageToSubscribe.on(qiwi.events.REACT.LOGO,function(logo){return _this4.updateContext({logo:logo})}),pageToSubscribe.on(qiwi.events.REACT.PAGE_CLASS,function(reactClass){return _this4.updateContext({reactClass:reactClass})}),pageToSubscribe.on(qiwi.events.REACT.PAGE_DATA,function(data){return _this4.updatePage(data)}),pageToSubscribe.on(qiwi.events.FORWARD,function(){return _this4.change(function(){return router.forward()})}),pageToSubscribe.on(qiwi.events.BACK,function(){return _this4.change(function(){return router.back()})}),pageToSubscribe.on(qiwi.events.JUMP,function(condition){return _this4.change(function(){return router.jump(condition)})}),pageToSubscribe.on(qiwi.events.EXIT,function(params){return _this4.exit(params)})}},{key:"unlisten",value:function(pageToUnsubscribe){if(!pageToUnsubscribe)throw new Error("Page is "+pageToUnsubscribe+" while being unsubscribed from!");pageToUnsubscribe.off()}}]),Application}(),_export("default",Application)}}});