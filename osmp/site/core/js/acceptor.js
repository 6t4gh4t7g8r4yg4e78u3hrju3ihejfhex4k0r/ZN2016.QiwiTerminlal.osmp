"use strict";System.register(["dispatcher","terminal","statistics","stores/payment","stores/receipt","stores/provider","stores/terminal","model/limits"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Dispatcher,Terminal,statistics,Payment,Receipt,Provider,TerminalObject,Limits,_createClass,Acceptor;return{setters:[function(_dispatcher){Dispatcher=_dispatcher["default"]},function(_terminal){Terminal=_terminal["default"]},function(_statistics){statistics=_statistics["default"]},function(_storesPayment){Payment=_storesPayment["default"]},function(_storesReceipt){Receipt=_storesReceipt["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_storesTerminal){TerminalObject=_storesTerminal["default"]},function(_modelLimits){Limits=_modelLimits.Limits}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Acceptor=function(_Dispatcher){function Acceptor(){_classCallCheck(this,Acceptor);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Acceptor).call(this));return _this.paySumm=0,_this.prevCash=0,_this.cashSumm=0,_this.commiss=0,_this.commissLine=0,_this.coinCommiss=0,_this.coinCommissValue=0,_this.changeSumm=0,_this.changeCommiss=0,_this.fixSum=0,_this.minCash=0,_this}return _inherits(Acceptor,_Dispatcher),_createClass(Acceptor,[{key:"begin",value:function(){this.listenEvents();var result={};Payment.scheme!==Payment.SCHEME.QD&&11!==Payment.account.length&&(Payment.account="7"+Payment.account);var startValues={AccNum:Payment.account,PrvId:Provider.id.toString(),PrvName:Payment.scheme===Payment.SCHEME.QD?Provider.fullName:"Visa QIWI Wallet"};return Payment.terminalParams(Payment.TERMINAL_STEP.ACCOUNT).forEach(function(_ref){var name=_ref.name,value=_ref.value;return startValues[name]=value}),Terminal.send("JSONCommands",JSON.stringify(startValues),["AccAllow|AccDenied","PrvAllow|PrvDenied"]).then(function(_ref2){var _ref2$AccDenied=_ref2.AccDenied,AccDenied=void 0===_ref2$AccDenied?!1:_ref2$AccDenied,_ref2$PrvDenied=_ref2.PrvDenied,PrvDenied=void 0===_ref2$PrvDenied?!1:_ref2$PrvDenied;return AccDenied?Promise.reject(qiwi.i18n("errors.accountDenied")):PrvDenied?Promise.reject(qiwi.i18n("errors.providerDenied")):void 0}).then(function(){return Payment.sum.user>0?Terminal.send("JSONCommands",JSON.stringify({PrvId2:Payment.change.id.toString(),PrvName2:Payment.change.fullName,AccNum2:Payment.change.account.toString(),_extra_fixed_int_summ:Payment.sum.payment.toString(),MinCashLimit2:(Payment.change.limit.min||1).toString()}),["Prv2Allow|Prv2Denied","Acc2Allow|Acc2Denied"]):void 0}).then(function(){return Terminal.send("system.getforbiddenbanknotes","true","system.getforbiddenbanknotes")}).then(function(res){var forbidden=JSON.parse(res["system.getforbiddenbanknotes"]);result.forbidden=forbidden.length>0?"Не принимаются купюры "+forbidden.filter(function(_ref3){var currency=_ref3.currency;return 643===Number(currency)}).map(function(_ref4){var value=_ref4.value;return value}).join(", ")+" руб.":""}).then(function(){return Terminal.send("JSONCommands",JSON.stringify({MinCashLimit:(Payment.sum.user?Payment.sum.payment:Limits.mix(Provider.terminalLimit,{min:Payment.commissions.forwardSum(Provider.limit().min)}).min).toString(),MaxCashLimit:(Payment.change.id?TerminalObject.max:Limits.mix(Provider.terminalLimit,{max:Payment.commissions.forwardSum(Provider.limit().max)}).max).toString(),GetCommissionsInfo:"true",_extra_comment:Payment.comment,_extra_ev_trm_id:TerminalObject.id.toString(),Validator:"on"}),["CommissionsInfo","ValOn"],["MaxCash","MinCash"])}).then(function(res){return"true"===res.ValOn?(result.min=res.MinCash,result.max=res.MaxCash,result.commissions=JSON.parse(res.CommissionsInfo),result):Promise.reject("Техническая ошибка")})}},{key:"updatePaymentData",value:function(_ref5){var receipt=_ref5.receipt;Receipt.printed=function(){return receipt}}},{key:"getCoinCommiss",value:function(value){var index=value.lastIndexOf("percent_");return-1===index?0:parseFloat(value.substr(index+"percent_".length))}},{key:"getCoinCommissValue",value:function(value){var result=0;return value.split("|").map(function(prop){"TotalCommAmount"===prop.split(":")[0]&&(result=Number(prop.split(":")[1]))}),result}},{key:"listenEvents",value:function(){var _this2=this;Terminal.on("response",function(key,value){switch(key){case"ValTimeout":_this2.trigger("timeoutAcceptor");break;case"NominalCommProfile":_this2.coinCommiss=value?_this2.getCoinCommiss(value):0;break;case"NominalCommissionInfo":_this2.coinCommissValue=value?_this2.getCoinCommissValue(value):0;break;case"MinCash":_this2.minCash=value;break;case"CashSumm":if(_this2.cashSumm=Number(value),_this2.cashSumm>0){var note=_this2.cashSumm-_this2.prevCash;note>0&&(statistics.note({value:note}),_this2.prevCash=_this2.cashSumm)}break;case"PaySumm":_this2.paySumm=Number(value);break;case"CommisSumm":_this2.commiss=Number(value);break;case"CommProfileLine":_this2.commissLine=Number(value);break;case"PaySumm2":_this2.changeSumm=Number(value);break;case"CommisSumm2":_this2.changeCommiss=Number(value)}_this2.trigger("updateAcceptor",{cash:_this2.cashSumm,pay_summ:_this2.paySumm,commiss:_this2.commiss,commissLine:_this2.commissLine,coinCommiss:_this2.coinCommiss,coinCommissValue:_this2.coinCommissValue,change_summ:_this2.changeSumm,change_commiss:_this2.changeCommiss,minCash:_this2.minCash})})}},{key:"end",value:function(){return Terminal.send("Validator","off","ValOff").then(function(_ref6){var ValOff=_ref6.ValOff;return"true"!==ValOff?Promise.reject():void Terminal.off("response")})}},{key:"onShowPreloader",value:function(){this.trigger("preloaderAcceptor",{show:!0})}},{key:"onHidePreloader",value:function(){this.trigger("preloaderAcceptor",{show:!1})}},{key:"pay",value:function(){var _this3=this;return Terminal.send("Validator","off","ValOff").then(function(_ref7){var ValOff=_ref7.ValOff;return"true"===ValOff?(qiwi.utils.delay(qiwi.utils.bind(_this3.onShowPreloader,_this3),100),Number(_this3.paySumm)>=Number(_this3.minSumm)?(Payment.terminalParams(Payment.TERMINAL_STEP.PAY).forEach(function(_ref8){var name=_ref8.name,value=_ref8.value;return Terminal.send(name,value)}),Payment.extras.forEach(function(_ref9){var name=_ref9.name,value=_ref9.value;return Terminal.send(name,value)}),Receipt.printed.forEach(function(_ref10){var name=_ref10.name,value=_ref10.value;return Terminal.send(name,value)})):Receipt.printedFail.forEach(function(_ref11){var name=_ref11.name,value=_ref11.value;return Terminal.send(name,value)}),Terminal.send("CreatePay","true","PaySuccess",null,18e4).then(function(_ref12){var PaySuccess=_ref12.PaySuccess;return qiwi.utils.delay(qiwi.utils.bind(_this3.onHidePreloader,_this3),100),"true"===PaySuccess?Terminal.send("GetCurrentPaymentData","true","GetCurrentPaymentData"):Promise.reject({fatal:!0})}).then(function(_ref13){var GetCurrentPaymentData=_ref13.GetCurrentPaymentData;return statistics.money({cash:_this3.cashSumm,to_provider:_this3.paySumm,to_change:0}),{txn_id:GetCurrentPaymentData,success:Number(_this3.cashSumm)>=Number(_this3.minSumm)}})):Terminal.send("GetDeficientAmount","true","DeficientAmount").then(function(_ref14){var DeficientAmount=_ref14.DeficientAmount,deficientArray=DeficientAmount.split(", ");return Promise.reject({fatal:!1,deficient:deficientArray&&deficientArray.length>0&&Number(deficientArray[1])>0?qiwi.i18n("pay_page.deficient")+" "+qiwi.utils.toSum(deficientArray[1])+" "+deficientArray[0]:""})})})}},{key:"minSumm",get:function(){return Payment.sum.payment||Payment.commissions.forwardSum(Provider.limit().min)}}]),Acceptor}(Dispatcher),_export("default",Acceptor)}}});