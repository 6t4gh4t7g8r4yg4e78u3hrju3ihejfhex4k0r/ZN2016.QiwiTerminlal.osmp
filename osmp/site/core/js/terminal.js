"use strict";System.register(["dispatcher"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Dispatcher,_createClass;return{setters:[function(_dispatcher){Dispatcher=_dispatcher["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_export("default",new(function(_Dispatcher){function _class(){_classCallCheck(this,_class);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this));return _this.RESPONSE="response",_this.REQUEST="request",_this.TIMEOUT=5e3,_this.OPTIONAL_TIMEOUT=1e3,_this.processcommand=window.terminal&&window.terminal.processcommand,_this}return _inherits(_class,_Dispatcher),_createClass(_class,[{key:"send",value:function(key,value,waiting,optional){var _this2=this,maximumTimeout=arguments.length<=4||void 0===arguments[4]?5e3:arguments[4],p=Promise.resolve();return value||(value=""),key===this.REQUEST?"string"==typeof value?this._massiveSend(qiwi.utils.invoke(value.split("&"),"split","="),"0","1",waiting,optional):value.length===+value.length?this._massiveSend(value,"name","value",waiting,optional):this._massiveSend(qiwi.utils.pairs(value),"0","1",waiting,optional):((waiting||optional)&&(waiting=this._responseParser(waiting),optional=this._responseParser(optional),p=new Promise(function(resolve,reject){var result={},timeoutId=void 0,onResp=function onResp(key,value){var off=function(action){_this2.off(_this2.RESPONSE,onResp),action(waiting.length?"Maratl не ответил следующими командами: "+waiting.join(", ")+(optional.length?", а также опциональными: "+optional.join(", "):""):result)},iterator=function iterator(item){if(Array.isArray(item)){if(item=qiwi.utils.reject(item,iterator),item.length>0)return!1}else if(-1!==item.indexOf(key.toLowerCase()))return result[key]=value,!1;return!0};clearTimeout(timeoutId),timeoutId=qiwi.utils.delay(off,maximumTimeout,reject),key&&(value=qiwi.utils.isUndefined(value)||qiwi.utils.isNull(value)?"":value,waiting=waiting.filter(iterator),optional=optional.filter(iterator),0===waiting.length&&(clearTimeout(timeoutId),0===optional.length?off(resolve):qiwi.utils.delay(off,_this2.OPTIONAL_TIMEOUT,resolve)))};_this2.on(_this2.RESPONSE,onResp)})),key&&(window.watchMaratl&&"function"==typeof window.watchMaratl&&window.watchMaratl(">>>",key,value),this.processcommand(key.toString(),value.toString())),p)}},{key:"wait",value:function(waiting,optional,maximumTimeout){return this.send(null,null,waiting,optional,maximumTimeout)}},{key:"receive",value:function(key,value){window.watchMaratl&&"function"==typeof window.watchMaratl&&window.watchMaratl("<<<",key,value),this.trigger(this.RESPONSE,key,value)}},{key:"_responseParser",value:function(){var array=arguments.length<=0||void 0===arguments[0]?[]:arguments[0];return array=Array.isArray(array)?array:[array],array.map(function(item){return"string"==typeof item?-1!==item.indexOf("|")?item.split("|").map(function(subitem){return subitem.toLowerCase()}):item.toLowerCase():item}).filter(function(item){return!!item})}},{key:"_massiveSend",value:function(array,keyName,valName,waiting,optional){return qiwi.utils.initial(array).forEach(function(item){this.send(item[keyName],item[valName])}.bind(this)),this.send(qiwi.utils.last(array)[keyName],qiwi.utils.last(array)[valName],waiting,optional)}},{key:"_massiveReceive",value:function(array){var _this3=this,receiveClosure=function(array,keyName,valName){var timeout=arguments.length<=3||void 0===arguments[3]?50:arguments[3];setTimeout(function(){return array.forEach(function(item){return _this3.receive(item[keyName],item[valName])})},timeout)};array.forEach(function(_ref){var v=_ref.values,t=_ref.timeout;"string"==typeof v?receiveClosure(qiwi.utils.invoke(v.split("&"),"split","="),"0","1",t):v.length===+v.length?receiveClosure(v,"name","value",t):receiveClosure(qiwi.utils.pairs(v),"0","1",t)})}}]),_class}(Dispatcher)))}}});