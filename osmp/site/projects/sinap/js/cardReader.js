"use strict";System.register(["terminal","dispatcher"],function(_export,_context){function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Terminal,Dispatcher,_createClass,COMMAND,TIMEOUT,EVENT,CardReader;return{setters:[function(_terminal){Terminal=_terminal["default"]},function(_dispatcher){Dispatcher=_dispatcher["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),COMMAND="bankcardreader.command",TIMEOUT=1e3,EVENT={POWER:"power",ABSTENCY:"abstency",CARD_MOVEMENT:"cardMovement",CARD_DATA_ERROR:"cardDataError",CARD_DATA:"cardData"},CardReader=function(_Dispatcher){function CardReader(){_classCallCheck(this,CardReader);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(CardReader).call(this));return _this.isOn=!1,_this.cardInserted=!1,_this.polling=!1,_this.stopRestarting=null,Terminal.on("response",function(key,value){key===COMMAND&&_this.handleCommand(JSON.parse(value))}),_this}return _inherits(CardReader,_Dispatcher),_createClass(CardReader,[{key:"start",value:function(){var _this2=this;this.polling=!0,this.on(EVENT.ABSTENCY,function(){_this2.isAbsent&&_this2.stop()}),this.isAbsent===!1&&(this.stopRestarting&&this.stopRestarting(),this.stopRestarting=this.on(EVENT.POWER,function(){_this2.isOn||_this2.isAbsent!==!1||_this2.start()})),this.isOn||Terminal.send(COMMAND,JSON.stringify({method:"start"}))}},{key:"stop",value:function(){var _this3=this;return this.polling=!1,this.stopRestarting&&this.stopRestarting(),Terminal.send(COMMAND,JSON.stringify({method:"stop"})),this.check().then(function(){return _this3.off()}).then(function(){return _this3.isAbsent=void 0})}},{key:"check",value:function(){return Terminal.send(COMMAND,JSON.stringify({method:"status"}),COMMAND)}},{key:"handleCommand",value:function(_ref){var method=_ref.method,_ref$result=_ref.result,result=void 0===_ref$result?{}:_ref$result,error=_ref.error;switch(method){case"data":error?this.trigger(EVENT.CARD_DATA_ERROR,error):this.trigger(EVENT.CARD_DATA,{number:result.number,expirationDate:new(Function.prototype.bind.apply(Date,[null].concat(_toConsumableArray(("20"+result.exp_date).split(/(?=\d{2}$)/).reverse())))),name:name.trim().toLowerCase().split("/")}),this.check();break;case"status":error?(this.isAbsent=!0,this.isOn=!1):(this.isAbsent=!1,this.isOn="on"===result.state,this.cardInserted=result.inserted);break;case"start":this.check();break;case"stop":this.isOn=!1}}},{key:"polling",set:function(v){var _this4=this;if(v){if(this._poll=!0,this.cycle)return;this.cycle=Promise["while"](function(){return _this4.polling?_this4.check().then(function(){return Promise.wait(TIMEOUT)}):(_this4.cycle=null,Promise.reject())})}else this._poll=!1},get:function(){return this._poll}},{key:"isAbsent",get:function(){return this._isAbsent},set:function(v){this._isAbsent!==v&&this.trigger(EVENT.ABSTENCY,this._isAbsent=v)}},{key:"isOn",get:function(){return this._isOn},set:function(v){this._isOn!==v&&this.trigger(EVENT.POWER,this._isOn=v)}},{key:"cardInserted",get:function(){return this._cardInserted},set:function(v){this._cardInserted!==v&&this.trigger(EVENT.CARD_MOVEMENT,this._cardInserted=v)}},{key:"EVENT",get:function(){return EVENT}}]),CardReader}(Dispatcher),_export("default",new CardReader)}}});