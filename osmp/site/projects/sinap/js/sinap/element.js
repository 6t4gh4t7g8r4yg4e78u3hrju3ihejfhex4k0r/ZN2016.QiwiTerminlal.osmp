"use strict";System.register(["./condition","./validator","./widget","autocomplete","../sinap","./container","requests/sinap"],function(_export,_context){function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Condition,Validator,Widget,Autocomplete,Sinap,Container,Request,_set,_get,_createClass,TYPE,Element,Field,Hidden,Visible,Dependency,Reference,parse;return{setters:[function(_condition){Condition=_condition["default"]},function(_validator){Validator=_validator["default"]},function(_widget){Widget=_widget["default"]},function(_autocomplete){Autocomplete=_autocomplete["default"]},function(_sinap){Sinap=_sinap["default"]},function(_container){Container=_container["default"]},function(_requestsSinap){Request=_requestsSinap["default"]}],execute:function(){_set=function set(object,property,value,receiver){var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);null!==parent&&set(parent,property,value,receiver)}else if("value"in desc&&desc.writable)desc.value=value;else{var setter=desc.set;void 0!==setter&&setter.call(receiver,value)}return value},_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),TYPE={FIELD:"field",DEPENDENCY:"dependency",REFERENCE:"ref"},Element=function(){function Element(){_classCallCheck(this,Element)}return _createClass(Element,[{key:"pages",value:function(){return Promise.resolve([])}},{key:"fill",value:function(){return Promise.resolve()}},{key:"data",get:function(){return null}}]),Element}(),Field=function(_Element){function Field(name){_classCallCheck(this,Field);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Field).call(this));return _this._name=name,_this}return _inherits(Field,_Element),_createClass(Field,[{key:"submit",value:function(){this._submitted=!0}},{key:"unsubmit",value:function(){this._submitted=!1}},{key:"name",get:function(){return this._name}},{key:"innerValue",get:function(){return this._value}},{key:"displayValue",get:function(){return null}},{key:"value",get:function(){return this._value},set:function(v){return this._value=v}},{key:"info",get:function(){return this._info||""}},{key:"title",get:function(){return this._title||""}},{key:"prompt",get:function(){return this._prompt||""}},{key:"sideInfo",get:function(){return this._sideInfo||null}},{key:"submitted",get:function(){return!!this._submitted}},{key:"valid",get:function(){return Promise.resolve()}},{key:"showOnConfirm",get:function(){return this._showOnConfirm||!1}},{key:"widget",get:function(){return this._widget||null}}]),Field}(Element),Hidden=function(_Field){function Hidden(_ref){var name=_ref.name,value=_ref.value;_classCallCheck(this,Hidden);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Hidden).call(this,name));return _this2.defaultValue=value,_this2.value=_this2.defaultValue,_this2}return _inherits(Hidden,_Field),_createClass(Hidden,[{key:"pages",value:function(){return Promise.resolve([{fields:[this],layout:null}])}},{key:"fill",value:function(from){var _this3=this;if(this.submitted)return Promise.resolve();if(this.name===Sinap.WELCOME_VALUE)return this.submit(),Promise.resolve();var field=from.find(function(extra){return extra.name===_this3.name});return field?(this.value=field.value,this.submit(),from.splice(from.findIndex(function(extra){return extra.name===_this3.name}),1),Promise.resolve()):(this.defaultValue&&(this.value=this.defaultValue,this.submit()),Promise.resolve())}},{key:"data",get:function(){return{name:this.name,server:this.value,display:this.displayValue,inner:this.innerValue,title:this.showOnConfirm?this.title:null,reference:this}}}]),Hidden}(Field),Visible=function(_Hidden){function Visible(_ref2){var name=_ref2.name,_ref2$view=_ref2.view,title=_ref2$view.title,info=_ref2$view.info,prompt=_ref2$view.prompt,widget=_ref2$view.widget,sideInfo=_ref2$view.sideInfo,value=_ref2.value,hideFromConfirmationScreen=_ref2.hideFromConfirmationScreen,validator=_ref2.validator,sensitiveData=_ref2.sensitiveData,semantics=_ref2.semantics;_classCallCheck(this,Visible);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(Visible).call(this,{name:name,value:value}));if(_this4.unsubmit(),!qiwi.utils.isObject(widget))throw new Error("Некорректный виджет элемента: "+JSON.stringify(widget));_this4._title=title,_this4._info=info,_this4._prompt=prompt,_this4._sideInfo=sideInfo,_this4.value=value||"",_this4._showOnConfirm=void 0===hideFromConfirmationScreen||!hideFromConfirmationScreen,_this4._validators=[],validator&&_this4._validators.push(Validator(validator)),sensitiveData&&(_this4.sensitive="true"===sensitiveData||sensitiveData===!0||!1);var SEMANTICS_TYPE={LAST_NAME:"LastName",OWNER_LAST_NAME:"OwnerLastName",FIRST_NAME:"FirstName",OWNER_FIRST_NAME:"OwnerFirstName",MIDDLE_NAME:"MiddleName",OWNER_MIDDLE_NAME:"OwnerMiddleName",BIRTH_DATE:"BirthDate",EMAIL:"Email",CARD:"CardNumber"};switch(semantics&&semantics.type){case SEMANTICS_TYPE.FIRST_NAME:case SEMANTICS_TYPE.OWNER_FIRST_NAME:widget.autocomplete=new Autocomplete("../../res/names_first.txt!text",{threshold:2});break;case SEMANTICS_TYPE.MIDDLE_NAME:case SEMANTICS_TYPE.OWNER_MIDDLE_NAME:widget.autocomplete=new Autocomplete("../../res/names_middle.txt!text",{threshold:2});break;case SEMANTICS_TYPE.LAST_NAME:case SEMANTICS_TYPE.OWNER_LAST_NAME:widget.autocomplete=new Autocomplete("../../res/names_second.txt!text",{threshold:2});break;case SEMANTICS_TYPE.EMAIL:widget.keyboard=Widget.KEYBOARD.EMAIL;break;case SEMANTICS_TYPE.CARD:widget.feature=Widget.FEATURE.CARD,_this4._validators.push(Validator({type:Validator.TYPE.CARD}))}return _this4._widget=Widget(widget),_this4.widget.layout===Widget.LAYOUT.SWITCH&&(_this4.value=_this4.widget.toggle()),_this4}return _inherits(Visible,_Hidden),_createClass(Visible,[{key:"pages",value:function(){if(this.widget.choices&&0===this.widget.choices.length)throw new Error("Не определены варианты выбора для элемента-списка");return Promise.resolve([{title:this.prompt||this.title||qiwi.i18n("pages.sinap.repeat.title"),prompt:this.prompt,fields:[this],layout:this.widget.layout}])}},{key:"fill",value:function(from){var _this5=this;return _get(Object.getPrototypeOf(Visible.prototype),"fill",this).call(this,from).then(function(){return _this5.name!==Sinap.WELCOME_VALUE&&_this5.submitted?_this5.valid:Promise.resolve()})["catch"](function(e){return Promise.reject("Некорректное значение для поля "+_this5.name+" в избранном.")})}},{key:"valid",get:function(){var _this6=this;return this._validators.length?Promise.all(this._validators.map(function(validator){return validator.validate(_this6.value)})):_get(Object.getPrototypeOf(Visible.prototype),"valid",this)}},{key:"displayValue",get:function(){return this.widget.toDisplay(this.innerValue)}},{key:"value",get:function(){return this.widget.toServer(this.innerValue)},set:function(v){return _set(Object.getPrototypeOf(Visible.prototype),"value",v,this)}}]),Visible}(Hidden),Dependency=function(_Element2){function Dependency(_ref3){var condition=_ref3.condition,content=_ref3.content;_classCallCheck(this,Dependency);var _this7=_possibleConstructorReturn(this,Object.getPrototypeOf(Dependency).call(this));if(!condition||!content)throw new Error("Не указаны требуемые свойства dependency (condition: "+condition+", content: "+content+")");return _this7.condition=Condition(condition),_this7.container=Container(content),_this7}return _inherits(Dependency,_Element2),_createClass(Dependency,[{key:"pages",value:function(_pages){return Promise.resolve(this.on(_pages)?this.container.pages(_pages):[])}},{key:"terms",value:function(pages){return this.on(pages)&&this.container.terms(pages)}},{key:"on",value:function(pages){return this.condition.met(pages)}},{key:"fill",value:function(from,pages){return this.on(pages)?this.container.fill(from,pages):Promise.resolve()}}]),Dependency}(Element),Reference=function(_Element3){function Reference(_ref4){var id=_ref4.id,title=_ref4.title,message=_ref4.message,params=_ref4.params;_classCallCheck(this,Reference);var _this8=_possibleConstructorReturn(this,Object.getPrototypeOf(Reference).call(this));return _this8.id=id,_this8.title=title,_this8.message=message,_this8.params=params,_this8.params.forEach(function(param){return param.value=null}),_this8.container=null,_this8}return _inherits(Reference,_Element3),_createClass(Reference,[{key:"pages",value:function(_pages2){var _this9=this,values=this.valuesFromPages(_pages2);return this.on(values)?(this.container&&!this.difference(values)?Promise.resolve():this.fetch(values)).then(function(){return _this9.container?_this9.container.pages(_pages2):[]}):Promise.resolve()}},{key:"terms",value:function(pages){return this.container&&this.container.terms(pages)}},{key:"valuesFromPages",value:function(pages){return pages.reduce(function(memo,page){var pageValues=page.fields.reduce(function(smemo,field){return field.submitted&&(smemo[field.name]=field.value||""),smemo},{});for(var key in pageValues)memo[key]=pageValues[key];return memo},{})}},{key:"difference",value:function(values){return Object.keys(values).length?this.params.some(function(_ref5){var field=_ref5.field,value=_ref5.value;return values[field]!==value}):!1}},{key:"on",value:function(values){return this.params.every(function(_ref6){var field=_ref6.field;return void 0!==values[field]})}},{key:"fetch",value:function(values){var _this10=this;return this.params=this.params.map(function(param){return param.value=values[param.field],param}),new Request("refs").send({id:this.id},this.params.reduce(function(memo,_ref7){var field=_ref7.field,value=_ref7.value;return memo[field]=value,memo},{})).interpose(function(){},function(){return _this10.container=null}).then(function(res){return _this10.container=Container(res)})}},{key:"fill",value:function(){return Promise.resolve("reference")}}]),Reference}(Element),parse=function(config){switch(config.type){case TYPE.FIELD:return config.view?new Visible(config):new Hidden(config);case TYPE.DEPENDENCY:return new Dependency(config);case TYPE.REFERENCE:return new Reference(config);default:throw new Error("Некорректный тип контейнера: "+config.type)}},parse.TYPE=TYPE,_export("default",parse)}}});