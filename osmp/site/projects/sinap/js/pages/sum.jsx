"use strict";System.register(["jsx!pages/page","stores/payment","stores/provider","../sinap","validators","jsx!elements/pageHeader","jsx!elements/inputSum","jsx!elements/numpad","jsx!elements/commissionInfoBlock","jsx!elements/infoBubble","jsx!elements/button"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,Payment,Provider,Sinap,validators,PageHeader,SumField,Numpad,CommissionBlock,InfoBubble,Button,_createClass,_get,Sum;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_storesPayment){Payment=_storesPayment["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_sinap){Sinap=_sinap["default"]},function(_validators){validators=_validators["default"]},function(_jsxElementsPageHeader){PageHeader=_jsxElementsPageHeader["default"]},function(_jsxElementsInputSum){SumField=_jsxElementsInputSum["default"]},function(_jsxElementsNumpad){Numpad=_jsxElementsNumpad["default"]},function(_jsxElementsCommissionInfoBlock){CommissionBlock=_jsxElementsCommissionInfoBlock["default"]},function(_jsxElementsInfoBubble){InfoBubble=_jsxElementsInfoBubble["default"]},function(_jsxElementsButton){Button=_jsxElementsButton["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},Sum=function(_Page){function Sum(){return _classCallCheck(this,Sum),_possibleConstructorReturn(this,Object.getPrototypeOf(Sum).apply(this,arguments))}return _inherits(Sum,_Page),_createClass(Sum,[{key:"onShow",value:function(){var _this2=this;return _get(Object.getPrototypeOf(Sum.prototype),"onShow",this).call(this).then(function(){return _this2.updateNavigation({nextButton:{enabled:!1}}),_this2.update()})}},{key:"performForward",value:function(){var _this3=this;return new Promise(function(resolve,reject){return Payment.sum.total>Provider.terminalLimit.max?reject(qiwi.i18n("pages.sum.terminalMax",{sum:Provider.terminalLimit.max,currency:qiwi.i18n("currency.rub.short")})):Payment.sum.total<Provider.terminalLimit.min?reject(qiwi.i18n("pages.sum.terminalMin",{sum:Provider.terminalLimit.min,currency:qiwi.i18n("currency.rub.short")})):Payment.sum.user>Provider.limit().max?reject(qiwi.i18n("pages.sum.providerMax",{sum:Provider.limit().max,currency:qiwi.i18n("currency.rub.short")})):Payment.sum.user<Provider.limit().min?reject(qiwi.i18n("pages.sum.providerMin",{sum:Provider.limit().min,currency:qiwi.i18n("currency.rub.short")})):void resolve()}).then(function(){return _get(Object.getPrototypeOf(Sum.prototype),"performForward",_this3).call(_this3)})["catch"](function(error){return _this3.showPopup({type:"error",message:error&&error.message||error||qiwi.i18n("errors.application")})})}},{key:"onUpdate",value:function(_ref){var sum=_ref.sum,valid=_ref.valid,firstRender=_ref.firstRender;return this.updateNavigation({nextButton:{enabled:valid}}),Number(sum)!==Payment.sum.user||firstRender?Payment.updateSum(sum):Promise.reject()}},{key:"createClass",value:function(){return _get(Object.getPrototypeOf(Sum.prototype),"createClass",this).call(this,{componentWillMount:function(){var initialSum=this.props.initialSum;this.setState({input:initialSum})},shouldComponentUpdate:function(_,nextState){var _state=this.state,prevInput=_state.input,prevFull=_state.full,nextInput=nextState.input,nextFull=nextState.full;return nextInput!==prevInput||nextFull!==prevFull},render:function(){var _this4=this,_props=this.props,_onUpdate=_props.onUpdate,showPopup=_props.showPopup,validator=_props.validator,provider=_props.provider,description=_props.description,commission=_props.commission,deadline=_props.deadline,_state2=this.state,input=_state2.input,cut=_state2.cut,full=_state2.full,infoBubbleElement=void 0,infoButtonElement=void 0;return commission&&(infoBubbleElement=React.createElement(InfoBubble,{text:[qiwi.i18n("pages.sum.hint",{commission:commission}),deadline]})),description&&(infoButtonElement=React.createElement(Button,{className:"info-button",onClick:function(){return showPopup({type:"info",title:qiwi.i18n("pages.sinap.information.title"),message:React.createElement("div",{className:"markdown-info-popup",dangerouslySetInnerHTML:{__html:description}})})}})),React.createElement("div",{className:"page-sum"},React.createElement(PageHeader,{provider:provider,title:qiwi.i18n("pages.sum.title")}),React.createElement(SumField,{validator:validator,value:input,onUpdate:function(_ref2){var sum=_ref2.sum,valid=_ref2.valid;input!==sum&&_this4.setState({input:sum}),_onUpdate({sum:sum,valid:valid,firstRender:void 0===full}).then(function(){var _ref3=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],total=_ref3.total,totalFee=_ref3.totalFee;(total||totalFee)&&Number(sum)?_this4.setState({full:total,cut:totalFee}):_this4.setState({full:0,cut:0})})}}),React.createElement(CommissionBlock,{cut:cut,full:full}),infoBubbleElement,React.createElement(Numpad,{withDot:!0,onClick:function(symbol){return _this4.setState({input:input+symbol.toString()})}}),infoButtonElement)}})}},{key:"props",get:function(){var _this5=this,terms=Sinap.terms;return{showPopup:function(config){return _this5.showPopup(config)},validator:new validators.SumValidator(1,15e3),provider:Provider.fullName,description:terms.description,initialSum:(Payment.sum.user||terms.sumConstraint&&terms.sumConstraint.suggested&&terms.sumConstraint.suggested.amount||0).toString(),commission:terms.commission&&terms.commission.comment(),deadline:terms.deadline}}}]),Sum}(Page),_export("default",Sum)}}});