"use strict";System.register(["terminal","stores/provider","stores/payment","stores/receipt","./sinap/container","./sinap/terms","./sinap/receipt","./sinap/widget","./sinap/miscInfo","model/limits"],function(_export,_context){function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var Terminal,Provider,Payment,ReceiptStore,Container,Terms,Receipt,Widget,MiscInfo,Limits,_slicedToArray,_createClass,_LAYOUT_PAGE,LAYOUT_PAGE,WELCOME_VALUE,Sinap;return{setters:[function(_terminal){Terminal=_terminal["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_storesPayment){Payment=_storesPayment["default"]},function(_storesReceipt){ReceiptStore=_storesReceipt["default"]},function(_sinapContainer){Container=_sinapContainer["default"]},function(_sinapTerms){Terms=_sinapTerms["default"]},function(_sinapReceipt){Receipt=_sinapReceipt["default"]},function(_sinapWidget){Widget=_sinapWidget["default"]},function(_sinapMiscInfo){MiscInfo=_sinapMiscInfo["default"]},function(_modelLimits){Limits=_modelLimits.Limits}],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_LAYOUT_PAGE={},_defineProperty(_LAYOUT_PAGE,Widget.LAYOUT.INFO,"staticField"),_defineProperty(_LAYOUT_PAGE,Widget.LAYOUT.LIST,"choiceField"),_defineProperty(_LAYOUT_PAGE,Widget.LAYOUT.RADIO,"choiceField"),_defineProperty(_LAYOUT_PAGE,Widget.LAYOUT.WELCOME,"choiceField"),_defineProperty(_LAYOUT_PAGE,Widget.LAYOUT.TEXT,"inputField"),LAYOUT_PAGE=_LAYOUT_PAGE,WELCOME_VALUE="WELCOME_DO_NOT_CHANGE_OR_YOU_WILL_BE_FIRED",Sinap=new(function(){function _class(){_classCallCheck(this,_class),this.container=null,this._receipt=null,this._pages=[],this.activated=!1,this.blocked=new Set}return _createClass(_class,[{key:"init",value:function(){var _this=this;if(this.container)return Promise.resolve();var qd=Provider.id;return Terminal.send("sinap.getqdproviders",JSON.stringify([qd.toString()]),"sinap.QDProviders").then(function(_ref){var config=_ref["sinap.QDProviders"];if(!config)return Promise.reject("Провайдера "+qd+" не существует в БД.");var data=JSON.parse(config)[qd];return"not found"===data?Promise.reject("Provider "+qd+" is not found in SINAP DB"):(_this.container=Container(data.content,!0),_this._receipt=Receipt(data.receipt),_this.miscInfo=MiscInfo(data.miscInfo),void(_this.miscInfo.info&&(Provider.sideInfo={phone:_this.miscInfo.info})))}).then(function(){return _this.update()},function(error){throw console.warn("Ошибка загрузки конфигурации SINAP'а: "+error),new qiwi.errors.UserError(qiwi.i18n("sinap.errors.incorrect_form"),error,qiwi.errors.ACTIONS.EXIT)})}},{key:"fieldNamed",value:function(required){try{return this.fields.find(function(_ref2){var name=_ref2.name;return name===required}).reference}catch(e){return null}}},{key:"valueOf",value:function(required){try{return this.fields.find(function(_ref3){var name=_ref3.name;return name===required}).server}catch(e){return null}}},{key:"forward",value:function(){var _this2=this;return this.activated&&this.currentPage&&this.currentPage.fields.forEach(function(field){return field.submit()}),this.update().then(function(){return _this2.current},function(e){return setTimeout(function(){throw new qiwi.errors.UserError(e.message||qiwi.i18n("sinap.errors.incorrect"),e)},1),_this2.back()}).then(function(layout){return layout?Promise.resolve(layout):_this2.forward()})}},{key:"back",value:function(){var _this3=this;return this.previousPage?(this.previousPage.fields.filter(function(field){return!_this3.blocked.has(field.name)}).forEach(function(field){return field.unsubmit()}),this.update().then(function(){return _this3.current},function(e){return setTimeout(function(){throw new qiwi.errors.UserError(e.message||qiwi.i18n("sinap.errors.incorrect"),e)},1),_this3.back()}).then(function(layout){return layout?Promise.resolve(layout):_this3.back()})):Promise.reject()}},{key:"jump",value:function(){var _this4=this;return this.update().then(function(){return _this4.current})}},{key:"commit",value:function(){var _this5=this;if(!this.terms)throw console.warn("Terms is absent on form commit"),new qiwi.errors.UserError(qiwi.i18n("pages.common.error"),-2,qiwi.errors.ACTIONS.EXIT);this.terms.isQD?Provider.offertus=qiwi.utils.require("../../params.json").then(function(_ref4){var _ref5=_slicedToArray(_ref4,1),info=_ref5[0].info;return qiwi.utils.require("../../pages/resourses/"+info["offer-type"]+".html!text").then(function(data){return data.map(function(file){return file.replace(/#(aof-.*)\s/g,function(match,variable){return info[variable]}).replace(/\n/g,"<br>")})})}):Provider.offertus=["../../QK_oferta_erk_vqw.xml","../../QK_oferta_full.xml","../../QK_oferta_bank.xml","../../QK_oferta_fns.xml"],Provider.qw=this.terms.qw||null,Provider.id=this.terms.qd,Payment.scheme=this.terms.isQD?Payment.SCHEME.QD:this.terms.isQWOnline?Payment.SCHEME.QW_ONLINE:Payment.SCHEME.QW_OFFLINE,Payment.commissions=this.terms.commission,Provider.limits=Limits.mix({min:1},this.terms.limits,this.terms.sumConstraint&&this.terms.sumConstraint.limit),this.sum?Payment.updateSum(this.sum):Payment.resetSum(),this.terms.isQD||(ReceiptStore.virtualOptions={money:!1}),ReceiptStore.virtualData=function(){return{inner:_this5.receipt.virtual}},ReceiptStore.printed=function(){return[{name:"prt_top_msg",value:qiwi.i18n("receipt.thanks")}].concat(_toConsumableArray(_this5.receipt.printed))},ReceiptStore.printedFail=function(){return _this5.terms.isQD?[]:[{name:"prt_top_msg",value:qiwi.i18n("pages.final.fail.description.deficient").replace("pages.final.fail.description.deficient","")||qiwi.i18n("finalPage.deficient_alert")}]},Provider.identificationRequired=this.terms.identification?this.terms.identification.required:!1,Payment.description=(this.terms.deadline?this.terms.deadline+"\n\n":"")+(this.terms.isQWOnline?"Данные, которые вы заполнили, сохранены.\nДля быстрой оплаты используйте\n«Повторить платеж»":"");var values=this.valuesObject;Payment.qwAccount=values[this.FIELDS.ACCOUNT],this.terms.isQD?(Payment.account=values[this.FIELDS.ACCOUNT],Payment.accountFormatter=null):this.terms.isQWOnline||delete values[this.FIELDS.ACCOUNT];for(var key in values)Payment.addExtra({name:key,value:values[key]},!0);Payment.addTerminalParam({name:"AccountMask",value:"NNNNXXXXXNN"},{condition:function(){return!_this5.terms.isQD},step:Payment.TERMINAL_STEP.ACCOUNT})}},{key:"clean",value:function(){for(this.deactivate(),this.unblock(),this.pages.forEach(function(page){return page.fields.forEach(function(field){field.unsubmit(),field.value=field.defaultValue})});!this.currentPage.layout;)this.currentPage.fields.forEach(function(field){return field.submit()});return this.update()}},{key:"block",value:function(blocked){var _this6=this;this.unblock(),this.blockWelcome(),blocked?this.blocked=blocked:Object.keys(this.valuesObject).forEach(function(name){return _this6.blocked.add(name)})}},{key:"blockWelcome",value:function(){var _this7=this,field=this.fields.find(function(_ref6){var reference=_ref6.reference;return reference.widget&&reference.widget.choices&&reference.widget.choices.find(function(_ref7){var value=_ref7.value;return value===_this7.WELCOME_VALUE})});field&&this.blocked.add(field.name)}},{key:"unblock",value:function(){this.blocked.clear()}},{key:"deactivate",value:function(){this.activated=!1}},{key:"fill",value:function(values,sum){var _this8=this;if(sum&&(this.sum=Number(sum)),!values)return Promise.reject("Отсутствуют запомненные значения для заполнения формы");values=values.slice();var lastLength=values.length;return Promise.until(function(){return _this8.container.fill(values,_this8.pages).then(function(result){return-1!==result.indexOf("reference")?_this8.update():0===values.length?_this8.update():values.length===lastLength?_this8.update():(lastLength=values.length,_this8.update().then(function(){return _this8.currentPage?Promise.reject():Promise.resolve(result)}))},function(error){return Promise.resolve(new Error(error))})})}},{key:"update",value:function(){var _this9=this;return this.container.pages().then(function(pages){return _this9._pages=pages.filter(function(a){return!!a})})}},{key:"currentPage",get:function(){var _this10=this;return this.pages.find(function(page){return page.fields.some(function(field){return!field.submitted&&!_this10.blocked.has(field.name)})})}},{key:"previousPage",get:function(){var _this11=this;return this.pages.filter(function(page){return page.fields.every(function(field){return field.submitted})&&page.fields.some(function(field){return!_this11.blocked.has(field.name)})}).reverse()[0]}},{key:"pages",get:function(){return this._pages||[]}},{key:"fields",get:function(){return this.pages.reduce(function(memo,page){return[].concat(_toConsumableArray(memo),_toConsumableArray(page.fields.reduce(function(submemo,field){return[].concat(_toConsumableArray(submemo),[field.data])},[])))},[]).filter(function(a){return a})}},{key:"values",get:function(){var _this12=this;return this.fields.filter(function(_ref8){var name=_ref8.name,reference=_ref8.reference;return name!==_this12.WELCOME_VALUE&&reference.submitted})}},{key:"valuesObject",get:function(){return this.values.reduce(function(memo,_ref9){var name=_ref9.name,server=_ref9.server;return memo[name]=server,memo},{})}},{key:"groupedValues",get:function(){return this.pages.reduce(function(memo,page){var fieldValues=page.fields.reduce(function(submemo,field){return[].concat(_toConsumableArray(submemo),[field.data])},[]).filter(function(_ref10){var reference=_ref10.reference,title=_ref10.title;return reference.submitted&&title});return fieldValues.length>1?[].concat(_toConsumableArray(memo),[{display:fieldValues.map(function(_ref11){var display=_ref11.display;return display}).join(" "),title:page.title,name:fieldValues.map(function(_ref12){var name=_ref12.name;return name}).join("&")}]):[].concat(_toConsumableArray(memo),_toConsumableArray(fieldValues))},[])}},{key:"current",get:function(){return this.activated=!0,this.currentPage?Promise.resolve(LAYOUT_PAGE[this.currentPage.layout]):(this.commit(),Promise.reject())}},{key:"terms",get:function(){return this.container.terms(this.pages).reverse()[0]||Terms()}},{key:"firstTerms",get:function(){return this.container.terms(this.pages)[0]||Terms()}},{key:"receipt",get:function(){return this._receipt}},{key:"WELCOME_VALUE",get:function(){return WELCOME_VALUE}},{key:"FIELDS",get:function(){return{ACCOUNT:"account",ACCOUNT_TYPE:"account_type"}}}]),_class}()),_export("default",Sinap)}}});