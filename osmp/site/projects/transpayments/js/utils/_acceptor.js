"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;h=j=i=void 0,d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0}};define("../../projects/transpayments/js/utils/_acceptor",["dispatcher","terminal","statistics"],function(a,b,c){var d=function(a){function d(){_classCallCheck(this,d),_get(Object.getPrototypeOf(d.prototype),"constructor",this).call(this),this.paySumm=0,this.minSumm=0,this.prevCash=0,this.cashSumm=0}return _inherits(d,a),_createClass(d,[{key:"begin",value:function(a){var c=this,d=a.prv_id,e=a.prv_name,f=a.account,g=a.extras,h=a.min_summ,i=a.max_summ,j=a.receipt,k=a.fail_receipt;return this._paymentData={extras:g,receipt:j,fail_receipt:k},this.minSumm=h,new Promise(function(a,g){b.send("AccNum",f,"AccAllow|AccDenied").then(function(a){return a.AccDenied?void g("Нельзя совершить платеж с данным номером счета"):b.send("JSONCommands",JSON.stringify({PrvId:d,PrvName:e}),"PrvAllow|PrvDenied")}).then(function(a){return a.PrvDenied?void g("Провайдер запрещен"):b.send("system.getforbiddenbanknotes","true")}).then(function(){return b.send("MinCashLimit",h)}).then(function(){return b.send("MaxCashLimit",i)}).then(function(){return b.send("GetCommissionsInfo","true")}).then(function(){return b.send("Validator","on","ValOn",["system.getforbiddenbanknotes","MaxCash","MinCash","CommissionsInfo"])}).then(function(b){if("true"==b.ValOn){c.onUpdate(),c.onTimeout();var d={};d.limits="Можно внести не меньше "+qiwi.utils.toSum(b.MinCash)+" руб. и не больше "+qiwi.utils.toSum(b.MaxCash)+" руб.";var e=JSON.parse(b["system.getforbiddenbanknotes"]);d.forbidden=e.length>0?"Не принимаются купюры "+e.filter(function(a){return"643"==a.currency}).map(function(a){return a.value}).join(", ")+" руб.":"",d.commissions=JSON.parse(b.CommissionsInfo),a(d)}else g("Техническая ошибка")})})}},{key:"onTimeout",value:function(){var a=this;b.on("response",function(b,c){qiwi.utils.delay(qiwi.utils.bind(a.refresh,a),100),"ValTimeout"==b&&a.trigger("timeoutAcceptor")})}},{key:"onUpdate",value:function(){var a=this;b.send(null,null,["CashSumm","PaySumm","CommisSumm"]).then(function(b){if(a.trigger("updateAcceptor",{cash:qiwi.utils.toSum(b.CashSumm),pay_summ:qiwi.utils.toSum(b.PaySumm),commiss:qiwi.utils.toSum(b.CommisSumm)}),a.paySumm=Number(b.PaySumm),a.cashSumm=Number(b.CashSumm),Number(b.CashSumm)>0){var d=Number(b.CashSumm)-a.prevCash;d>0&&(c.note({value:d}),a.prevCash=Number(b.CashSumm))}qiwi.utils.delay(qiwi.utils.bind(a.refresh,a),100)})}},{key:"refresh",value:function(){this.onUpdate()}},{key:"end",value:function(){return new Promise(function(a,c){b.send("Validator","off","ValOff").then(function(b){"true"==b.ValOff?a():c()})})}},{key:"onShowPreloader",value:function(){this.trigger("preloaderAcceptor",{show:!0})}},{key:"onHidePreloader",value:function(){this.trigger("preloaderAcceptor",{show:!1})}},{key:"pay",value:function(){var a=this;return new Promise(function(d,e){b.send("Validator","off","ValOff").then(function(f){if("true"==f.ValOff){if(qiwi.utils.delay(qiwi.utils.bind(a.onShowPreloader,a),100),Number(a.paySumm)>=Number(a.minSumm)){if(a._paymentData.extras)for(var g in a._paymentData.extras)b.send(g,a._paymentData.extras[g]);if(a._paymentData.receipt)for(var h in a._paymentData.receipt)b.send(h,a._paymentData.receipt[h])}else if(a._paymentData.fail_receipt)for(var h in a._paymentData.fail_receipt)b.send(h,a._paymentData.fail_receipt[h]);b.send("CreatePay","true","PaySuccess").then(function(f){qiwi.utils.delay(qiwi.utils.bind(a.onHidePreloader,a),100),"true"==f.PaySuccess?b.send("GetCurrentPaymentData","true","GetCurrentPaymentData").then(function(b){c.money({cash:a.cashSumm,to_provider:a.paySumm,to_change:0}),d({txn_id:b.GetCurrentPaymentData,success:Number(a.paySumm)>=Number(a.minSumm)})}):e({fatal:!0})})}else b.send("GetDeficientAmount","true","DeficientAmount").then(function(b){var c=b.DeficientAmount.split(", ");e({fatal:!1,deficient:c&&c.length>0?qiwi.utils.toSum(c[1])+" "+c[0]:""}),qiwi.utils.delay(qiwi.utils.bind(a.refresh,a),100)})})})}}]),d}(a);return d});