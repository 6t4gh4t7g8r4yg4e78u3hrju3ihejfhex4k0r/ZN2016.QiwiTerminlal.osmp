"use strict";System.register(["jsx!pages/page","terminal","stores/regProvider","model/appSettings","payment","model/user"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,Terminal,RegProvider,AppSettings,Payment,User,_slicedToArray,_createClass,_get,_class;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_terminal){Terminal=_terminal["default"]},function(_storesRegProvider){RegProvider=_storesRegProvider["default"]},function(_modelAppSettings){AppSettings=_modelAppSettings["default"]},function(_payment){Payment=_payment["default"]},function(_modelUser){User=_modelUser["default"]}],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this,"topupAccount"))}return _inherits(_class,_Page),_createClass(_class,[{key:"onShow",value:function(){var _this2=this;_get(Object.getPrototypeOf(_class.prototype),"onShow",this).call(this),this.showOferta="topup"==AppSettings.state.startup,this.account="",this._regexp=new RegExp("^d{10}$"),this.updateNavigation({nextButton:{enabled:!1}}),RegProvider.getProvider(AppSettings.state.topupProvider.QIWI).then(function(provider){Payment.state.logo="../img/ui_item/"+provider.logo,Payment.state.minSum=provider.minSum,Payment.state.maxSum=provider.maxSum,Payment.state.provider.id=AppSettings.state.topupProvider.QIWI,Payment.state.provider.fullName=provider.longName,_this2.providerName=provider.longName,Payment.state.ereceipt=AppSettings.state.topupEReceipt,Payment.state.ereceiptCompiler=function(data){return qiwi.utils.compileTemplate(data.ereceipt,{account:qiwi.utils.mask(data.account,"+7(***)-***-**-**"),trm_id:qiwi.terminal.id,date:(new Date).toLocaleFormat("%d.%m.%Y %H:%M:%S"),txn_id:data.insertMoney.txn_id,cash:qiwi.utils.toSum(data.insertMoney.cash)+" руб.",pay:qiwi.utils.toSum(data.insertMoney.pay)+" руб.",commiss:qiwi.utils.toSum(data.insertMoney.commiss)+" руб.",subscribtionFee:data.subscriptionFee&&data.insertMoney.pay>0?qiwi.utils.compileTemplate(qiwi.i18n("topupAccountPage.subcriptionFeeEreceiptText"),{amount:data.insertMoney.subscriptionFeeValue}):"",smsFee:"sms"==data.insertMoney.subscriptionFeeValue&&data.insertMoney.pay>0?qiwi.utils.compileTemplate(qiwi.i18n("topupAccountPage.smsFeeEreceiptText"),{amount:AppSettings.state.smsFee}):""})},Payment.setExtra({name:"comment",value:qiwi.utils.compileTemplate(AppSettings.state.topupComment,{version:qiwi.application.version})}),Terminal.send("GetMaxSummByPrv",AppSettings.state.topupProvider.QIWI,"GetMaxSummByPrv").then(function(res){Payment.state.maxSum=res.GetMaxSummByPrv}),provider.controls.map(function(control){"account"==control.name&&(_this2._regexp=new RegExp(control.regexp))}),_this2.setLogo(Payment.state.logo),User.authorizeState.authorized&&!Payment.state.account?_this2.updateField(User.login.src):_this2.updateField(Payment.state.account),_this2.update()},function(error){throw new qiwi.errors.UserError(qiwi.i18n("errors.providerDenied"),-1,function(){return _this2.exit()})}).done()}},{key:"performBackward",value:function(){"mainMenu"!=AppSettings.state.startup?this.exit():this.backward()}},{key:"performForward",value:function(){var _this3=this,defaultData=function(){User.mfStatus={state:!1,prvId:0},User.identificationStatus="full",User.limits.balanceLimitTotal=AppSettings.state.maxSum,User.limits.balanceLimitCurrent=AppSettings.state.maxSum,User.limits.spendLimitTotal=AppSettings.state.maxSum,User.limits.spendLimitUsed=0,User.subscriptionFee={isSmsNotificationEnabled:!1},User.exist=!0};this.request("wallet.check-user-topup",{trm_id:qiwi.terminal.id,version:qiwi.application.toString(),phone:"7"+this.account,currency:AppSettings.state.currentCurrency,check_megafon:1,check_pin:0,urls:["https://facecontrol.qiwi.com/proxy"],headers:{"X-Proxy-Url":"qw_internal_xml"},title:qiwi.utils.mask(this.account,"+7(***)-***-**-**")}).then(function(result){0==result.response.data.errorCode?(User.mfStatus={state:result.response.data.isMegafon,prvId:result.response.data.phonePrvId},User.identificationStatus=result.response.data.identificationStatus,User.limits.balanceLimitTotal=result.response.data.balanceLimitTotal,User.limits.balanceLimitCurrent=result.response.data.balanceLimitCurrent,User.limits.spendLimitTotal=result.response.data.spendLimitTotal,User.limits.spendLimitUsed=result.response.data.spendLimitUsed,User.subscriptionFee=result.response.data.subscriptionFee,User.checkUserXmlResponse=result.response.bodyXml,User.exist=result.response.data.exist):defaultData()},function(error){defaultData()}).done(function(){return _this3.existWallet(User.exist)})}},{key:"existWallet",value:function(exist){var _this4=this;this.loadElements(["checkBox"]).then(function(_ref){var _ref2=_slicedToArray(_ref,1),CheckBox=_ref2[0];_this4.showPopup({type:"dialog",title:exist?qiwi.utils.mask(_this4.account,"+7(***)-***-**-**"):qiwi.utils.compileTemplate(qiwi.i18n("topupAccountPage.existPopup.notExistTitle"),{phone:qiwi.utils.mask(_this4.account,"+7(***)-***-**-**")}),message:exist?qiwi.i18n("topupAccountPage.existPopup.message"):qiwi.i18n("topupAccountPage.existPopup.notExistMessage"),okHandler:function(){_this4.nextAction()},customContent:_this4.createReactElement(CheckBox,{className:"b-check-box_topup",checked:!0,color:"gray",onCheck:function(value){value?Payment.removeExtra("no_sms"):Payment.setExtra({name:"no_sms",value:"1"})},text:qiwi.i18n("topupAccountPage.existPopup.adv")}),okButtonText:exist?qiwi.i18n("topupAccountPage.existPopup.ok"):qiwi.i18n("topupAccountPage.existPopup.notExistOk"),cancelButtonText:exist?qiwi.i18n("topupAccountPage.existPopup.cancel"):qiwi.i18n("topupAccountPage.existPopup.notExistCancel")})})["catch"](function(error){throw new qiwi.errors.SystemError("Error load element for popup: ",error)}).done()}},{key:"nextAction",value:function(){var _this5=this;Number(User.limits.balanceLimitCurrent)<=Number(Payment.state.minSum)?"anonymous"==User.identificationStatus?this.showPopup({type:"question",title:qiwi.i18n("errors.default"),message:qiwi.i18n("topupAccountPage.limits.topupLimitErrorAnonym"),okHandler:function(){_this5.storage.set("ident_adv_counter",JSON.stringify({phone:_this5.account,user_profile:User.checkUserXmlResponse})),_this5.exit({url:"./index.html?identification"})},cancelHandler:function(){_this5.exit()},okButtonText:qiwi.i18n("topupAccountPage.limits.increaseLimit"),cancelButtonText:qiwi.i18n("topupAccountPage.limits.notIncreaseLimit")}):this.showPopup({type:"error",message:qiwi.utils.compileTemplate(qiwi.i18n("topupAccountPage.limits.topupLimitError"),{phone:AppSettings.state.bankSupportPhone})}):(Payment.state.account=this.account,User.mfStatus.state?this.jump("megafon"):this.jump("qiwi"))}},{key:"updateField",value:function(code){null===code?this.account=this.account.slice(0,-1):this.account.length<10&&(this.account+=code),this.updateNavigation({nextButton:{enabled:this._regexp.test(this.account)}}),this.update()}},{key:"createClass",value:function(){var _this6=this;return this.loadElements(["button","animatedTextField","numpad","infoBubble","pageHeader"]).then(function(_ref3){var _ref4=_slicedToArray(_ref3,5),Textfield=(_ref4[0],_ref4[1]),Numpad=_ref4[2],InfoBubble=_ref4[3],PageHeader=_ref4[4];return _get(Object.getPrototypeOf(_class.prototype),"createClass",_this6).call(_this6,{render:function(){var page=this.props.context;return React.createElement("div",{id:"topup-account-page",className:"content"},React.createElement(PageHeader,{provider:this.props.providerName,title:qiwi.i18n("topupAccountPage.title"),subtitle:qiwi.i18n("topupAccountPage.subtitle")}),React.createElement(Textfield,{onEraseClick:function(){return page.updateField(null)},text:this.props.account,width:"774",mask:{inner:"+7(***)***-**-**",shown:"+7(XXX)XXX-XX-XX"},eraseWidth:"133"}),React.createElement(Numpad,{onClick:function(code){return page.updateField(code)}}),this.props.showOferta?React.createElement("div",{className:"oferta-message"},qiwi.i18n("mainMenuPage.oferta_text").replace(/(\[).*$/g,""),React.createElement("span",{className:"button",onClick:function(){return page.jump("oferta")}},qiwi.i18n("mainMenuPage.oferta_text").replace(/^.*(\[)|(\]).*$/g,"")),qiwi.i18n("mainMenuPage.oferta_text").replace(/.*(\])/g,"")):null,React.createElement(InfoBubble,{className:"info",text:qiwi.i18n("topupAccountPage.attentionInfo")}))}})})}},{key:"state",get:function(){return{account:this.account,providerName:this.providerName,showOferta:this.showOferta}}}]),_class}(Page),_export("default",_class)}}});