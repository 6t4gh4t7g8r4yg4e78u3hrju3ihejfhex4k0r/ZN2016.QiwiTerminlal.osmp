"use strict";System.register(["jsx!pages/page","model/user","model/appSettings","payment","model/rates","terminal","commissions","model/invoices"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,User,AppSettings,Payment,Rates,Terminal,Commissions,Invoices,_slicedToArray,_createClass,_get,_class;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_modelUser){User=_modelUser["default"]},function(_modelAppSettings){AppSettings=_modelAppSettings["default"]},function(_payment){Payment=_payment["default"]},function(_modelRates){Rates=_modelRates["default"]},function(_terminal){Terminal=_terminal["default"]},function(_commissions){Commissions=_commissions["default"]},function(_modelInvoices){Invoices=_modelInvoices["default"]}],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this,"invoicesList"))}return _inherits(_class,_Page),_createClass(_class,[{key:"onShow",value:function(){var _this2=this;return _get(Object.getPrototypeOf(_class.prototype),"onShow",this).call(this).then(function(){return Rates.loaded?Promise.resolve():_this2.request("wallet.get-cross-rates-all",{rates:"",version:qiwi.application.toString()})})["catch"](function(error){return _this2.showPopup({type:"error",message:error.message,okHandler:function(){return _this2.performBackward()}})}).then(function(result){return result?(Rates.fill(result.response.data.rates),Promise.resolve()):Promise.resolve()},function(fail){throw new qiwi.errors.UserError(fail.message)}).then(function(){return User.hasUnpaidInvoices=!1,Payment.resetState(),0==User.invoices.length?Promise.reject():(_this2.setLogo("./img/icons/vqw.png"),_this2.providerName=AppSettings.state.invoiceProvider.name,Invoices.setData({list:User.invoices,rateCalculation:Rates.calculation.bind(Rates),currentCurrency:AppSettings.state.currentCurrency}),_this2.updateNavigation({nextButton:{enabled:Invoices.selectedItems.length>0,text:qiwi.i18n("invoicesPage.payButton")}}),_this2.update(),Promise.resolve())})["catch"](function(e){_this2.showPopup({type:"attention",title:qiwi.i18n("popups.attention"),message:qiwi.utils.compileTemplate(qiwi.i18n("invoicesPage.noInvoices"),{phone:User.login.formatted}),okHandler:function(){return _this2.performBackward()}})}).done()}},{key:"performForward",value:function(){var _this3=this;this.statistics.page_data({invoices_to_pay:Invoices.selectedItems.length}),Payment.state.invoices=Invoices.selectedItems,Payment.state.needIdent=Invoices.selectedItems.filter(function(item){return item.ident}).length>0,Payment.state.logo="./img/icons/vqw.png",Payment.state.minSum=qiwi.utils.round2(Invoices.total),Payment.state.change.wallet.id=AppSettings.state.change.wallet.id,Payment.state.fixSum.changeAccount=User.login.src,Payment.state.account=User.login.src,Payment.state.formattedAccount=User.login.formatted,Payment.state.transNumber=Payment.generateTransNumber(),Payment.state.provider.id=AppSettings.state.invoiceProvider.id,Payment.state.provider.fullName=AppSettings.state.invoiceProvider.name,Payment.state.qwCommissions=new Commissions([{commissionInfo:[{commissionFix:Invoices.totalCommission,commissionMax:"inf",commissionMin:0,commissionPercent:0,fromAmount:0,toAmount:"inf"}],providerId:"1"}],1),Payment.setQwSumAndCommiss(Invoices.total-Invoices.totalCommission),Payment.setExtra({name:"comment",value:qiwi.utils.compileTemplate(AppSettings.state.invoiceProvider.comment,{version:qiwi.application.version})}),Payment.setExtra({name:"ev_bill",value:1}),Payment.setExtra({name:"ev_scode",value:Payment.state.transNumber}),Payment.state.successReceipt=[{name:"",value:qiwi.utils.compileTemplate(AppSettings.state.invoiceProvider.successReceipt,{invoices:Invoices.selectedItems.map(function(item){return item.trm_id+": "+qiwi.utils.toSum(item.amount)+" "+item.currencyText+"<br>"+qiwi.i18n("invoicesPage.fee")+": "+qiwi.utils.toSum(item.amount_lk-item.amount)+" "+item.currencyText}).join("<br>")})}],Payment.state.ereceiptCompiler=function(data){return("cash"==data.paymentMethod?"Номер телефона/счета: "+data.formattedAccount+"\nНомер терминала: "+qiwi.terminal.id+"\nДата платежа: "+(new Date).toLocaleFormat("%d.%m.%Y %H:%M:%S")+"\n"+(data.insertMoney.txn_id?"Код операции: "+data.insertMoney.txn_id:"")+"\n\nВнесено: "+qiwi.utils.toSum(data.insertMoney.cash)+" руб.\nЗачислено: "+qiwi.utils.toSum(data.insertMoney.pay)+" руб.\nКомиссия: "+qiwi.utils.toSum(data.insertMoney.commiss)+" руб.\n\n":"ОПЛАТА С БАЛАНСА\n\nНомер кошелька: "+data.formattedAccount+"\nСписано: "+qiwi.utils.toSum(data.fixSum.sum)+" руб.\n\n")+data.successReceipt[0].value.replace(/<br>/g,"\n")+"\n"+(data.fixSum.sum>0&&"cash"==data.paymentMethod&&data.insertMoney.changeSumm>0?"\n\nПеречисление сдачи:\n"+data.fixSum.changeName+"\nНомер телефона/счета: "+data.formattedAccount+"\nЗачислено: "+qiwi.utils.toSum(data.insertMoney.changeSumm)+" руб.\nКомиссия: "+data.insertMoney.changeCommiss+" руб.":"")+"\n\n"+("cash"==data.paymentMethod?"Узнать статус платежа: info.qiwi.com":"")},Payment.state.failReceipt=[{name:"",value:AppSettings.state.invoiceProvider.failReceipt}],Terminal.send("GetMaxSummByPrv",Payment.state.provider.id,"GetMaxSummByPrv").then(function(res){if(res.GetMaxSummByPrv<_this3.total)throw new qiwi.errors.UserError(qiwi.utils.compileTemplate(qiwi.i18n("errors.overSum"),{sum:qiwi.utils.toSum(res.GetMaxSummByPrv)+" "+AppSettings.state.currentCurrencyTitle}));Payment.state.maxSum=res.GetMaxSummByPrv,_this3.forward()}).done()}},{key:"onCheckItems",value:function(items){Invoices.selectedItems=items,this.updateNavigation({nextButton:{enabled:Invoices.selectedItems.length>0}}),this.update()}},{key:"onSelect",value:function(item){item.checked=!0,Invoices.selectedItems=[item],this.performForward()}},{key:"createClass",value:function(){var _this4=this;return this.loadElements(["button","confirmationPayment","invoicesList","infoBubble","pageHeader"]).then(function(_ref){var _ref2=_slicedToArray(_ref,5),ConfirmationPayment=(_ref2[0],_ref2[1]),InvoicesList=_ref2[2],InfoBuble=_ref2[3],PageHeader=_ref2[4];return _get(Object.getPrototypeOf(_class.prototype),"createClass",_this4).call(_this4,{render:function(){var _this5=this;return React.createElement("div",{id:"invoices-page",className:"invoices-container"},React.createElement(PageHeader,{provider:this.props.providerName,title:1==this.props.invoices.length?qiwi.i18n("invoicesPage.titleOne"):qiwi.i18n("invoicesPage.titleMany"),subtitle:1==this.props.invoices.length?"":qiwi.i18n("invoicesPage.subtitleMany")}),1==this.props.invoices.length?React.createElement(ConfirmationPayment,{items:[{title:qiwi.i18n("invoicesPage.reciever"),text:this.props.invoices[0].trm_id},{title:qiwi.i18n("invoicesPage.date"),text:this.props.invoices[0].bill_date},{title:qiwi.i18n("invoicesPage.comment"),text:this.props.invoices[0].comment},{title:qiwi.i18n("invoicesPage.sumInvoiceOne"),text:qiwi.utils.toSum(this.props.invoices[0].amount)+" "+this.props.invoices[0].currencyText},{title:qiwi.i18n("invoicesPage.fee"),text:qiwi.utils.toSum(this.props.invoices[0].commission)+" "+this.props.invoices[0].toPayCurrencyText},{title:qiwi.i18n("invoicesPage.totalInvoice"),text:qiwi.utils.toSum(this.props.invoices[0].toPay)+" "+this.props.invoices[0].toPayCurrencyText}]}):React.createElement(InvoicesList,{list:this.props.invoices,onCheck:function(items){return _this5.props.onCheckItems(items)},onSelect:function(item){return _this5.props.onSelect(item)}}),this.props.invoices.length>1&&this.props.total>0?React.createElement(InfoBuble,{className:"info",width:260,text:qiwi.utils.compileTemplate(qiwi.i18n("invoicesPage.total"),{sum:qiwi.utils.toSum(this.props.total)})}):null)}})})}},{key:"props",get:function(){return{invoices:Invoices.all,total:Invoices.total,providerName:this.providerName,onCheckItems:this.onCheckItems.bind(this),onSelect:this.onSelect.bind(this)}}}]),_class}(Page),_export("default",_class)}}});