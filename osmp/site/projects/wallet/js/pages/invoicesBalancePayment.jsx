"use strict";System.register(["jsx!pages/balancePayment","stores/payment","stores/provider","stores/transaction","stores/receipt","model/invoices","model/user","model/appSettings","requests/request","terminal"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,Payment,Provider,Transaction,Receipt,Invoices,User,AppSettings,Request,Terminal,_createClass,_class;return{setters:[function(_jsxPagesBalancePayment){Page=_jsxPagesBalancePayment["default"]},function(_storesPayment){Payment=_storesPayment["default"]},function(_storesProvider){Provider=_storesProvider["default"]},function(_storesTransaction){Transaction=_storesTransaction["default"]},function(_storesReceipt){Receipt=_storesReceipt["default"]},function(_modelInvoices){Invoices=_modelInvoices["default"]},function(_modelUser){User=_modelUser["default"]},function(_modelAppSettings){AppSettings=_modelAppSettings["default"]},function(_requestsRequest){Request=_requestsRequest["default"]},function(_terminal){Terminal=_terminal["default"]}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this,"invoicesBalancePayment"))}return _inherits(_class,_Page),_createClass(_class,[{key:"requestPayment",value:function(){return this.request("wallet.invoice-pay",{login:"7"+User.login.src,pin:User.pin,group_id:"",invoices:"<bill-list>"+Invoices.selectedItems.map(function(item){return"<id>"+item.id+"</id>"}).join("")+"</bill-list>",invoicesList:Invoices.selectedItems,trm_id:qiwi.terminal.id,currency:AppSettings.state.currentCurrency,version:qiwi.application.toString()})}},{key:"removeInvoiceFromUser",value:function(){var index=-1,successIndex=-1;User.invoices.map(function(invoice){index++,Invoices.selectedItems[0].id==invoice.id&&(successIndex=index)}),successIndex>-1&&User.invoices.splice(successIndex,1)}},{key:"performForward",value:function(){var _this2=this;return this.requestPayment().then(function(result){var _result$response$data=result.response.data,errorCode=_result$response$data.errorCode,errorMessage=_result$response$data.errorMessage,successInvoices=_result$response$data.successInvoices;if(0==errorCode)return _this2.removeInvoiceFromUser(),successInvoices.filter(function(item){return 0==item.status}).length==Invoices.selectedItems.length?(Transaction.status=Transaction.STATUS.FULL,_this2.sendReceipt().then(function(){return _this2.jump("final")})):_this2.forward();throw new qiwi.errors.UserError(errorMessage)},function(fail){throw new qiwi.errors.UserError(fail.message)}).done()}}]),_class}(Page),_export("default",_class)}}});