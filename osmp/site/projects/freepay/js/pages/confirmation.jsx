"use strict";System.register(["jsx!pages/page","payment","model/freepay","validators","jsx!elements/textWithLink","model/user","terminal","constants/errorCodes"],function(_export,_context){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Page,Payment,Model,validators,TextWithLink,User,Terminal,Errors,_slicedToArray,_createClass,_get,_class;return{setters:[function(_jsxPagesPage){Page=_jsxPagesPage["default"]},function(_payment){Payment=_payment["default"]},function(_modelFreepay){Model=_modelFreepay["default"]},function(_validators){validators=_validators["default"]},function(_jsxElementsTextWithLink){TextWithLink=_jsxElementsTextWithLink["default"]},function(_modelUser){User=_modelUser["default"]},function(_terminal){Terminal=_terminal["default"]},function(_constantsErrorCodes){Errors=_constantsErrorCodes["default"]}],execute:function(){_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_class=function(_Page){function _class(){return _classCallCheck(this,_class),_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this))}return _inherits(_class,_Page),_createClass(_class,[{key:"onShow",value:function(){var _this2=this;return _get(Object.getPrototypeOf(_class.prototype),"onShow",this).call(this).then(function(){return _this2.showPreloader(),Terminal.send("JSONCommands",JSON.stringify({PrvId:Payment.state.provider.id.toString(),AccNum:User.login.src.toString(),getAccountNumber:User.login.src.toString(),"_extra_ext-bank-fee":Model.payment.walletFee,_extra_sum:Model.payment.sum,_extra_goal:Model.purposeOnline,_extra_from_name_f:Model.user.surname,_extra_from_name:Model.user.name,_extra_from_name_p:Model.user.patronym,CreateOnlinePay:"true"}),"AccDenied|OnlineResponse",null,18e4)}).then(function(_ref){var OnlineResponse=_ref.OnlineResponse,_ref$AccDenied=_ref.AccDenied,AccDenied=void 0===_ref$AccDenied?!1:_ref$AccDenied;if(AccDenied)return Promise.reject({text:qiwi.i18n("requests.transport"),code:-2,action:function(){return _this2.backward()}});_this2.hidePreloader();var result=JSON.parse(OnlineResponse);if(console.warn("result.resultCode="+result.resultCode),0!=result.resultCode){var errorText="";switch(result.resultCode){case 600:errorText=qiwi.i18n("requests.timeout");break;case 4:errorText=qiwi.i18n("confirmationPage.errorRequest");break;default:errorText=Errors.getError(result.resultCode)}return Promise.reject({text:errorText,code:result.resultCode,action:function(){return _this2.backward()}})}return Promise.resolve(result)}).then(function(result){var limit=Math.min(Payment.state.maxSum,User.limits.spendLimitTotal-User.limits.spendLimitUsed);if(Model.payment.total>limit)return Promise.reject({text:qiwi.i18n("confirmationPage.limitsError"),code:-1,action:function(){return _this2.exit()}});Model.bankInfo=result.fields,_this2.confirmItems=[{title:qiwi.i18n("confirmationPage.items.phone"),text:User.login.formatted},{title:qiwi.i18n("confirmationPage.items.fio"),text:Model.userString},{title:qiwi.i18n("confirmationPage.items.sum"),text:qiwi.utils.toSum(Model.payment.sum)+" руб."},{title:qiwi.i18n("confirmationPage.items.recipient"),text:Model.bankInfoString},{title:qiwi.i18n("confirmationPage.items.purpose"),text:Model.purposeOnline},{title:qiwi.i18n("confirmationPage.items.total.title"),shortText:!0,text:React.createElement(TextWithLink,{message:qiwi.utils.compileTemplate(qiwi.i18n("confirmationPage.items.total.text"),{sum:qiwi.utils.toSum(Model.payment.total)}),link:function(){return _this2.showPopup({type:"info",title:qiwi.i18n("confirmationPage.info.title"),message:qiwi.utils.compileTemplate(qiwi.i18n("confirmationPage.info.message.qw"),{sum:qiwi.utils.toSum(Payment.state.fixSum.qwCommission)})+"\n"+qiwi.utils.compileTemplate(qiwi.i18n("confirmationPage.info.message.qd"),{sum:qiwi.utils.toSum(Payment.state.fixSum.qdCommission)})})}})}],Payment.state.account=User.login.src,Payment.state.formattedAccount=User.login.formatted,Payment.state.fixSum.sum=Payment.state.minSum=qiwi.utils.round2(Number(Model.payment.sum)+qiwi.utils.round2(Number(Payment.state.fixSum.qwCommission))),Payment.setExtra({name:"ext-bank-fee",value:Payment.state.fixSum.qwCommission}),Payment.setExtra({name:"sum",value:Model.payment.sum}),Payment.setExtra({name:"goal",value:Model.purposeExtra}),Payment.setExtra({name:"from_name_f",value:Model.user.surname}),Payment.setExtra({name:"from_name",value:Model.user.name}),Payment.setExtra({name:"from_name_p",value:Model.user.patronym}),Payment.setExtra({name:"ev_account0",value:"client-software:"+qiwi.application.toString()}),Model.user.document["static"]&&Model.user.document["static"].map(function(extra){return Payment.setExtra({name:extra.key,value:extra.value})}),Payment.setExtra({name:Model.user.document.name,value:Model.user.document.value}),Payment.setExtra({name:"comment",value:qiwi.application.toString()});var receiptData=qiwi.utils.extend({},{termid:qiwi.terminal.id,name:Model.userFIO,bank:Model.bankInfoString,purpose:Model.purposeExtra,price:qiwi.utils.toSum(Number(Model.payment.sum))+" руб.",total:qiwi.utils.toSum(qiwi.utils.round2(Number(Model.payment.sum)+qiwi.utils.round2(Number(Payment.state.fixSum.qwCommission))))+" руб.",commission:qiwi.utils.toSum(Number(Payment.state.fixSum.qwCommission))+" руб."});Payment.state.successReceipt=Payment.prepareReceipt({template:Payment.state.receiptTemplate.successReceipt,data:receiptData}),Payment.state.ereceipt=Payment.prepareEReceipt({template:Payment.state.receiptTemplate.successReceipt,data:receiptData}),Payment.state.failReceipt=Payment.prepareReceipt({template:Payment.state.receiptTemplate.failReceipt,data:{}}),_this2.setLogo(Payment.state.logo),_this2.update()})["catch"](function(error){throw new qiwi.errors.UserError(error.text,error.code,error.action)}).done()}},{key:"createClass",value:function(){var _this3=this;return this.loadElements(["pageHeader","confirmationPayment","textWithLink"]).then(function(_ref2){var _ref3=_slicedToArray(_ref2,3),PageHeader=_ref3[0],ConfirmationPayment=_ref3[1],TextWithLink=_ref3[2];return _get(Object.getPrototypeOf(_class.prototype),"createClass",_this3).call(_this3,{render:function(){return React.createElement("div",{className:"confirmation-page"},React.createElement(PageHeader,{provider:this.props.providerName,title:qiwi.i18n("confirmationPage.title")}),React.createElement(ConfirmationPayment,{items:this.props.confirmItems}),React.createElement(TextWithLink,{message:qiwi.i18n("confirmationPage.oferta_text"),link:this.props.openOffertus}))}})})}},{key:"props",get:function(){var _this4=this;return{providerName:Payment.state.provider.fullName,confirmItems:this.confirmItems||[],openOffertus:function(){return _this4.jump("offertus")}}}}]),_class}(Page),_export("default",_class)}}});